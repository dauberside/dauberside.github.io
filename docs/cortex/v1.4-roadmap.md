# Cortex OS v1.4: Predictive Intelligence

**Status**: Planning Phase  
**Version**: v1.4.0 (未リリース)  
**前提**: v1.3 Intelligence 完成 (2025-12-05)  
**設計日**: 2025-12-08

---

## 🎯 コンセプト

**v1.3** が「学習して先回りする OS」だったのに対し、**v1.4** は **「記録を簡単にし、データを統合する OS」** です。

### キーテーマ

- **記録の摩擦ゼロ**: `/log` `/note` で即座に digest へ追記
- **データ一貫性**: digest ↔ tasks.json の自動同期
- **長期知性**: Weekly Intelligence で習慣パターン抽出

---

## 📊 3つのPhase

### 🎯 Phase 1: ログ記録の簡略化（超重要）

**Goal**: 「書きたいときにすぐ書ける」状態にする

**実装コスト**: 1-2時間  
**価値**: 毎日の生活の質が一段改善

#### `/log` コマンド

**目的**: タスク実績を即時 digest に追記

```bash
/log -t "環境変数修正" -d 12m -c admin
```

**機能**:
- `-t` (タスク名)
- `-d` (所要時間)
- `-c` (カテゴリ)
- 自動タイムスタンプ付与
- `patch_content` で安全に digest へ追記

**出力先**: `cortex/daily/YYYY-MM-DD-digest.md` の `## 進捗` セクション

**出力フォーマット**:
```markdown
### 1. タスク名 (HH:MM JST)
- **カテゴリ**: admin
- **所要時間**: 12分
- **メモ**: （オプション）
```

#### `/note` コマンド

**目的**: メモ・気づきを軽く記録

```bash
/note "n8n の cron は volume 永続化に注意"
```

**機能**:
- 1行メモを即座に追記
- タイムスタンプ自動付与
- digest の "Notes" サブセクションに追記

**出力先**: `cortex/daily/YYYY-MM-DD-digest.md` の `## 振り返り > ### 💡 学び` セクション

**出力フォーマット**:
```markdown
- **HH:MM JST**: メモ内容
```

---

### 🔄 Phase 2: システム間同期（自動一貫性維持）

**Goal**: digest と tasks.json が常に一致

**実装コスト**: 2-3時間  
**価値**: データの正確性が一段階アップ

#### digest → tasks.json 自動同期

**仕組み**:
1. `/log` で追加したタスクを tasks.json へ自動反映
2. 逆に tasks.json の完了タスクも digest へ反映
3. 双方向同期でデータの単一真実性を確保

**優先順位ルール** (競合時):
- **digest が正**: `/log` で明示的に記録されたタスク
- **tasks.json が正**: 自動生成されたメトリクス（duration, category）
- **タイムスタンプ比較**: 最新の更新を優先
- **同時編集検出**: Git conflict として警告、手動マージを促す

**実装方針**:
```python
# scripts/sync-digest-tasks.py
def sync_digest_to_tasks(digest_path, tasks_json_path):
    # 1. digest から完了タスクを抽出
    # 2. tasks.json に存在しないものを追加
    # 3. タイムスタンプ・カテゴリ・所要時間を同期
    # 4. 競合検出: digest.timestamp vs tasks.mtime
    # 5. 最新側を採用、古い側に conflict マーク
```

**同期方向の決定**:
```python
if digest_timestamp > tasks_timestamp:
    # digest → tasks.json
    merge_from_digest()
elif tasks_timestamp > digest_timestamp:
    # tasks.json → digest
    merge_from_tasks()
else:
    # 同時刻 → digest 優先（人間の記録を尊重）
    merge_from_digest()
```

#### 未完了タスクの自動検出

**仕組み**:
- `/wrap-up` 内で自動実行
- 今日のタスク完了率を計算
- 未完了タスク一覧を抽出
- 翌日への持越しフラグを設定

**出力**:
```json
{
  "completion_rate": 0.67,
  "completed": 2,
  "incomplete": 1,
  "carryover_tasks": ["Recipe 実行ログ検証"]
}
```

#### mood/energy 自己評価スコア

**仕組み**:
- `/wrap-up` で対話形式で入力
- または digest に手動記入

```bash
今日のエネルギー: 6/10
今日の集中力: 7/10
今日の満足度: 8/10
```

**活用**:
- rhythm / category と統合して予測精度向上
- 低エネルギー日のパターン検出
- 高集中日の条件抽出

---

### 📈 Phase 3: Weekly Intelligence

**Goal**: 1週間の傾向を自動分析

**実装コスト**: 3-4時間  
**価値**: 長期パターン分析の基礎

#### digest → weekly-summary 自動生成

**仕組み**:
```python
# scripts/generate-weekly-summary.py
def generate_weekly_summary(start_date, end_date):
    # 1. 7日分の digest を読み取り
    # 2. 傾向分析（カテゴリ分布、完了率推移）
    # 3. 可視化データ生成
    # 4. weekly-summary.md に出力
```

**出力内容**:
- 今週の傾向（カテゴリ分布グラフ）
- よくできた点 (AI 生成サマリー)
- 改善できる点 (パターン分析から)
- 来週の推奨アクション

**AI モデル使用**:
- **要約生成**: `gpt-4o-mini` (cost-effective, 十分な品質)
- **埋め込み**: `text-embedding-3-large` (既存 KB と統一)
- **プロンプト戦略**: Few-shot learning (過去の良い週次サマリーを例示)

#### 長期パターン抽出

**機能**:
- 4週間分の weekly-summary を分析
- 月次トレンドの検出
- 習慣パターンの発見

**例**:
```
- 毎週金曜は集中力が高い（平均 8.2/10）
- 週初めは admin タスクが多い傾向
- 深夜作業後は翌日のエネルギーが低下
```

---

## 🛠️ 実装詳細

### ファイル構成

```
scripts/
├── log.py                    # /log コマンド実装
├── note.py                   # /note コマンド実装
├── sync-digest-tasks.py      # digest ↔ tasks.json 同期
└── generate-weekly-summary.py # Weekly Intelligence

cortex/daily/
└── YYYY-MM-DD-digest.md      # /log /note の出力先

cortex/weekly/
└── YYYY-W##-summary.md       # 週次サマリー
```

### 依存関係

**Phase 1**:
- 依存なし（独立実装可能）
- `patch_content` ユーティリティ関数

**Phase 2**:
- Phase 1 完了後
- `tasks.json` スキーマ確定

**Phase 3**:
- Phase 1-2 完了後
- Weekly aggregator (既存)

---

## 📊 期待される効果

### Phase 1 完了後

- **記録時間**: 5分 → 30秒 (90%短縮)
- **記録頻度**: 1日1回 → 随時 (10倍増加)
- **データ量**: 週10件 → 週50件 (5倍増加)

### Phase 2 完了後

- **データ一貫性**: 60% → 95% (手動同期不要)
- **分析精度**: +20% (データ量増加による)

### Phase 3 完了後

- **長期洞察**: 週次 → 月次トレンド可視化
- **習慣発見**: 自動パターン抽出

---

## 🚨 リスクと対策

### Phase 1

**リスク**: ファイル競合（複数人が同時編集）

**対策**:
- ファイルロック機構
- Git conflict 検出
- 自動マージ処理

### Phase 2

**リスク**: digest と tasks.json の形式差異

**対策**:
- 正規化関数で吸収
- Graceful degradation

### Phase 3

**リスク**: データ不足で分析不可

**対策**:
- 最低7日分のデータ確認
- データ不足時は警告表示

---

## ⏱️ 実装スケジュール

### 想定工数

| Phase | 実装 | テスト | ドキュメント | 合計 |
|-------|------|--------|------------|------|
| Phase 1 | 1h | 0.5h | 0.5h | 2h |
| Phase 2 | 2h | 0.5h | 0.5h | 3h |
| Phase 3 | 2.5h | 0.5h | 1h | 4h |
| **合計** | **5.5h** | **1.5h** | **2h** | **9h** |

### マイルストーン

- **Day 1**: Phase 1 実装・テスト
- **Day 2**: Phase 2 実装・テスト
- **Day 3**: Phase 3 実装・テスト
- **Day 4**: 統合テスト・ドキュメント完成

**完成予定**: 2025-12-11 (3日後)

---

## 🔗 関連ドキュメント

- [v1.3 Intelligence 完成報告](/docs/cortex/v1.3-COMPLETION.md)
- [v2.0 Roadmap](/docs/architecture/cortex-os-v2-roadmap.md)
- [Task Entry Schema](/docs/requirements/task-entry-schema.md)
- [今日の Digest (2025-12-08)](/cortex/daily/2025-12-08-digest.md)

---

## 📝 設計メモ

### Journal-Driven Loop (JDL) との整合性

v1.4 は JDL モデルを強化します：

```
00:30 JST: Digest テンプレート生成（空の器）
  ↓
日中: /log /note で実績・メモを随時追記  ← Phase 1
  ↓
22:00 JST: /wrap-up で総括 ← Phase 2 統合
  ↓
翌朝 08:00 JST: Recipe 03 が Slack 通知
  ↓
週末: Weekly Summary 自動生成 ← Phase 3
```

### v1.3 からの進化

| v1.3 | v1.4 |
|------|------|
| 学習する | **記録しやすくする** |
| 先回りする | **統合する** |
| 診断する | **長期パターンを発見する** |

---

**Status**: Ready to Implement 🚀  
**Next**: Phase 1 `/log` `/note` 実装開始
