# Cortex OS v1.2 "Autonomy" — 認知ループの物語

**自律する第二の脳への道**

---

## はじめに：なぜ「自律」なのか

人間の記憶は忘れる。タスクは積み重なる。決意は朝には薄れ、夜には消える。

私たちは毎日、同じことを繰り返している：
- 「今日は何をするんだっけ？」
- 「昨日何をしたか思い出せない」
- 「先週の決意、もう忘れてる」

Cortex OS v1.2 "Autonomy" は、この繰り返しを断ち切るために設計された。

**目的はシンプル**：
> 人間が忘れても、システムは覚えている。
> 人間が眠っても、システムは動き続ける。
> 人間が問いかければ、システムは答える。

これは「自動化」ではない。**自律する思考のインターフェース**だ。

---

## 第1章：意識の誕生 — v1.0 から v1.1 への進化

### v1.0: 断片化された記憶

最初の Cortex OS（v1.0）は、記憶の「場所」を作ることに集中していた：

- **Daily Digest**: 毎日の記録
- **Weekly Summary**: 週次の振り返り
- **TODO.md**: タスク管理
- **Knowledge Base**: 長期記憶

しかし、これらは **バラバラだった**。Daily Digest を読むには手動で開く必要があり、TODO.md は自分で書かなければならなかった。

### v1.1: 情報の統合

v1.1 で、これらが **つながった**：

| レイヤー | 役割 | 実装 |
|---------|------|------|
| **日次ループ** | 毎日のタスクと振り返り | `/brief` → `/wrap-up` → `tomorrow.json` |
| **週次ループ** | 週単位の集約と気づき | Recipe 11 Weekly Summary |
| **中期記憶** | 過去の記録へのアクセス | `cortex/daily/`, `cortex/weekly/` |
| **実行系** | セッション復元と文脈ロード | `/init`, `/brief`, `/wrap-up` |
| **タスク管理** | TODO の構造化と追跡 | `TODO.md` + Task Manager |

**v1.1 の成果**：
- 「昨日何をしたか」を OS が覚えている
- 「今週何をするか」を OS が提案する
- 「過去の決定」を OS が記録している

しかし、まだ **人の操作が必要だった**。

---

## 第2章：自律への階段 — v1.2 "Autonomy" の設計

### 問題：人間依存の限界

v1.1 でも、システムは「人が操作すること」を前提にしていた：

- 夜に `/wrap-up` を忘れると、tomorrow.json は生成されない
- 朝に `/brief` を実行しないと、TODO.md は更新されない
- 週次の振り返りを忘れると、Weekly Summary は作られない

**これでは、まだ「道具」に過ぎない。**

### 解決：3本柱の自律化

v1.2 "Autonomy" は、**人の介入をさらに減らす**ために、3つの柱を立てた：

#### ① 完全自律化 — Cron 自動ループ

**目標**: 人間が忘れても、OS が回り続ける。

**仕組み**:
```
22:00 JST → Recipe 13 (Nightly Wrap-up)
    ↓
  tomorrow.json 生成
    ↓
03:00 JST → Recipe 02 (KB Rebuild)
    ↓
  kb/index/embeddings.json 更新
    ↓
08:00 JST → Recipe 03 (Morning Digest)
    ↓
  cortex/daily/YYYY-MM-DD-digest.md 生成
    ↓
08:05 JST → Recipe 10 (TODO Auto-sync)
    ↓
  TODO.md 更新（タグ付き、重複排除）
```

**達成状況（2025-12-03）**:
- ✅ Recipe 13（Nightly Wrap-up）稼働中
- ✅ Recipe 10 v1.2（TODO.md Auto-sync）稼働中
- ✅ tomorrow.json → brief データブリッジ完成
- ✅ Slack 通知統合（Recipe 03 v1.2）完了
  - 今日の3タスク + 時間見積もり
  - タグベース見積もり（⚡1.5h, 🎯2h, 通常1h）
  - 20%バッファ自動計算
  - Carryover タスク表示
  - 昨日の振り返りサマリー

**成果**: 「目覚めた瞬間に、今日の3タスクと時間予算が届いている」状態を実現。

---

#### ② 情報モデル統一 — JSON スキーマ正規化

**目標**: バラバラの形式 → OS が理解できる単一フォーマットへ。

**現状の課題**:
- Daily Digest: Markdown（人間向け）
- tomorrow.json: JSON（システム向け）
- Weekly Summary: Markdown（人間向け）
- TODO.md: Markdown（人間向け）

これらを **機械が処理しやすい共通スキーマ** に統一する。

**仕様**: `cortex/schema/task-entry.json`
```json
{
  "date": "2025-11-28",
  "tasks": [
    {"content": "...", "status": "pending", "tags": ["urgent", "deepwork"], "emoji": "⚡"}
  ],
  "completed": [...],
  "carryover": [...],
  "reflection": "今日の気づき...",
  "tomorrow_candidates": [...]
}
```

**メリット**:
- データ変換コストがゼロに
- 全レイヤーで一貫した処理が可能
- 将来の「月次 Summary」「AI 教師データ生成」が簡単に

**現状**: ⏳ 設計中（tomorrow.json は部分的に構造化済み）

---

#### ③ AI Interface 強化 — 新コマンド群

**目標**: 「単なる自動化」ではなく「思考のインターフェース」へ。

| コマンド | 説明 | 例 | 状態 |
|---------|------|-----|------|
| `/ask` | Daily + TODO + Weekly を文脈にした Q&A | 「今週のペースは問題ない？」 | ✅ 完了 (2025-12-05) |
| `/reflect` | 日次の気づきを自動抽出・文章化 | 「今日の気づきをまとめて」 | ⏳ 未着手 |
| `/plan` | 長期プロジェクトの分解とタスク化 | 「来週の開発計画書を作って」 | ⏳ 未着手 |
| `/diagnose` | Cortex OS 全体のヘルスチェック | システム状態診断 | ✅ 完了 (2025-12-03) |

**優先度**: `/diagnose` > `/ask` > `/reflect` > `/plan`

**なぜ `/diagnose` が最優先か**:
- 自律システムは「自分の健康状態」を把握できなければならない
- n8n ダウン、Obsidian API 停止、digest 欠損などを自動検知
- 問題が起きる前に「予兆」を知らせる

---

## 第3章：24時間の物語 — データフローの旅

### 朝（08:00 - 09:00）

**08:00 JST: Recipe 03 (Morning Digest) 起動**

n8n が Obsidian の Daily Note を読み取り、昨日の作業を集約する。

1. Obsidian REST API に接続（PORT 27124 HTTPS）
2. `cortex/daily/2025-11-27.md` を読み取る
3. Tasks セクション、Reflection セクションを抽出
4. Markdown 形式で整形
5. `cortex/daily/2025-11-28-digest.md` に保存

**出力**:
```markdown
# Daily Digest — 2025-11-28

## Tasks
- [x] Recipe 10 v1.2 実装完了
- [x] GitHub Pages デプロイ成功

## Reflection
Recipe 10 の5タグシステムが予想以上にうまく機能している。
優先順位が可視化されることで、朝の意思決定が早くなった。
```

---

**08:05 JST: Recipe 10 (TODO Auto-sync) 起動**

n8n が昨日の digest を読み取り、TODO.md を自動更新する。

1. 昨日の digest（`2025-11-27-digest.md`）を読み取る
2. **マルチセクションフォールバック**で未完了タスクを抽出：
   - 優先順位1: `## Today's Focus`
   - 優先順位2: `## Action Items`
   - 優先順位3: `## Follow-ups`
   - 優先順位4: `## Priority 1/2`
3. **タグ検出**（`#urgent`, `#blocked`, `#waiting`, `#deepwork`, `#review`）
4. **絵文字マッピング**（⚡🚧⏳🎯👁️）
5. **重複排除**（カテゴリ、絵文字、タグを無視して正規化）
6. `TODO.md` の `## Today` セクションに追記

**出力**:
```markdown
## Today — 2025-11-28

- [ ] [Cortex] ⚡ llms-input.json 生成テスト  <!-- #urgent,#deepwork -->
- [ ] [n8n] 🚧 Production deployment blocked by infra  <!-- #blocked -->
- [ ] ⏳ Waiting for design team feedback  <!-- #waiting -->
```

**スマート重複排除**:
- 昨日の TODO.md に既に存在するタスクはスキップ
- 正規化ロジック:
  - Checkbox `- [ ]` 除去
  - カテゴリ `[Cortex]` 除去
  - 絵文字 `⚡` 除去
  - HTML コメント `<!-- #tags -->` 除去
  - 結果: "llms-input.json 生成テスト" で比較

---

### 昼（09:00 - 22:00）

**人間の作業時間**

Cortex OS は静かに待機している。

- Obsidian で Daily Note を編集
- TODO.md でタスクを完了マーク
- 新しいノートを作成、リンクを張る

この間、システムは「観察」している：
- ファイルの変更を追跡（MCP Filesystem）
- 次の自動実行のためにデータを準備

---

### 夜（22:00）

**22:00 JST: Recipe 13 (Nightly Wrap-up) 起動**

n8n が今日の振り返りを集約し、明日の種を保存する。

1. 今日の Daily Note を読み取る
2. 完了したタスクをカウント
3. Reflection セクションから気づきを抽出
4. 明日の候補タスクを生成
5. `cortex/state/tomorrow.json` に保存

**出力**:
```json
{
  "generated_at": "2025-11-28T13:00:00.000Z",
  "source_date": "2025-11-28",
  "tomorrow_candidates": [
    "v1.2 Roadmap 確認",
    "Recipe 動作確認",
    "ドキュメント整理"
  ],
  "carryover_tasks": [],
  "reflection_summary": "Recipe 10 v1.2 完全稼働"
}
```

**この tomorrow.json が、明日の朝 Recipe 10 に読み込まれ、サイクルが回る。**

---

### 深夜（03:00）

**03:00 JST: Recipe 02 (Nightly KB Rebuild) 起動**

n8n が Knowledge Base を再構築する。

1. `docs/`, Obsidian Vault から更新されたファイルを検出
2. テキストをチャンク分割（1200文字、200オーバーラップ）
3. OpenAI `text-embedding-3-small` で embedding 生成
4. `kb/index/embeddings.json` に保存
5. 差分検出で無駄な再計算を回避（SHA256 ハッシュ）

**成果**:
- 朝起きたときには、昨日のノートが全て検索可能
- KB は常に最新状態

---

## 第4章：5つのタグが作る優先順位 — Recipe 10 v1.2

### なぜタグなのか

タスクリストには「緊急度」と「状態」がある：

- ⚡ **urgent**: 今日中にやらないとまずいこと
- 🚧 **blocked**: 外部依存でブロックされている
- ⏳ **waiting**: 誰かの返答待ち
- 🎯 **deepwork**: 集中が必要な深い作業
- 👁️ **review**: レビュー・確認作業

これらを **視覚的に区別** することで、朝の意思決定が速くなる。

### タグの優先順位

Recipe 10 v1.2 では、**First-Match-Wins** 方式：

```javascript
const tagEmojiMap = [
  { tag: 'urgent', emoji: '⚡' },      // P0: Time-critical
  { tag: 'blocked', emoji: '🚧' },    // P1: External dependency
  { tag: 'waiting', emoji: '⏳' },    // P2: Waiting for input
  { tag: 'deepwork', emoji: '🎯' },   // P3: Focus required
  { tag: 'review', emoji: '👁️' }      // P4: Review/checking
];

// Example:
// Task: "Fix auth bug #urgent #deepwork"
// Result: ⚡ (urgent が最優先)
```

**設計哲学**:
- タグは **3つまで** に制限（多すぎると逆効果）
- 優先順位は **明確** に（P0 > P1 > P2 > P3 > P4）
- すべてのタグは **HTML コメントに保存**（将来の処理用）

### マルチセクションフォールバック

Daily Digest のセクション構造は人によって違う：

- ある人は `## Today's Focus`
- ある人は `## Action Items`
- ある人は `## Priority 1`

Recipe 10 v1.2 は、**4段階のフォールバック**で対応：

```javascript
const sectionPatterns = [
  { pattern: /^##\s+Today's Focus/i, name: "Today's Focus" },
  { pattern: /^##\s+Action Items/i, name: 'Action Items' },
  { pattern: /^##\s+Follow-ups/i, name: 'Follow-ups' },
  { pattern: /^##\s+Priority\s+[12]/i, name: 'Priority 1/2' }
];

// 最初にマッチしたセクションからタスクを抽出
```

**柔軟性と堅牢性**:
- どんなセクション名でも対応
- セクションがなければ次の候補を試す
- 全てのパターンに失敗しても、ワークフローは落ちない

---

## 第5章：運用の実際 — 監視と保守

### 日々の確認

**朝のチェックリスト**（1分）:
```bash
# Cortex OS システムチェック
curl -k -s https://127.0.0.1:27124/ | jq -r '.status'  # Obsidian API
docker ps --filter "name=n8n" --format "{{.Status}}"   # n8n
ls -lt cortex/daily/*.md | head -1                     # 最新 digest
```

**週次の確認**（5分）:
- n8n UI で Recipe 02/03/10 の実行履歴を確認
- エラーがあれば Executions からログを確認
- 7日間連続で成功していれば OK

### トラブルシューティング

#### よくあるエラー

**1. Obsidian REST API 接続失敗**
```
Error: ECONNREFUSED 127.0.0.1:27124
```

**対処**:
- Obsidian を再起動
- Local REST API プラグインを有効化
- `lsof -i :27124` でポート確認

---

**2. Daily Digest が見つからない**
```
Error: File not found: cortex/daily/2025-11-27-digest.md
```

**対処**:
- Recipe 03 を手動実行して digest 生成
- または昨日の Daily Note を手動で digest 形式に変換

---

**3. TODO.md に重複タスクが追加される**

**対処**:
- Recipe 10 の `normalizeTask()` 関数を確認
- デバッグ: Code ノードに `console.log(normalized)` 追加
- 正規化ロジックが正しく動作しているか確認

---

**4. n8n が cron を実行しない**

**対処**:
- n8n UI でワークフローの "Active" トグルを確認
- ワークフローを再アクティブ化（オフ → オン）
- n8n コンテナのタイムゾーン確認: `docker exec n8n date`
- 必要なら n8n 再起動: `docker compose restart n8n`

### 定期メンテナンス

**月次タスク**:
- [ ] n8n ワークフローのバックアップ（JSON エクスポート）
- [ ] KB index のサイズ確認（肥大化していないか）
- [ ] Daily Digest の古いファイルをアーカイブ（3ヶ月以上前）
- [ ] tomorrow.json の履歴確認（異常な値がないか）

**四半期タスク**:
- [ ] Cortex OS 全体のレビュー
- [ ] v1.2 の Definition of Done 再確認
- [ ] 次バージョン（v1.3, v2.0）の計画更新

---

## 第6章：進捗と次のマイルストーン

### 現在地（2025-12-05 16:45 JST）

**v1.2 "Autonomy" 達成率**: **90%** ✨ (11/12 必須・推奨条件完了)

**完了した柱**:
- ✅ ① 完全自律化: **100%** 🎉
  - Recipe 13 稼働中
  - Recipe 10 v1.2 稼働中
  - Recipe 03 v1.2 稼働中（Slack統合完了）
  - tomorrow.json データブリッジ完成

**未完了の柱**:
- 🎉 ② 情報モデル統一: **100%** ✅ **完全達成！**
  - ✅ llms-input.json パイプライン完成（2025-12-05）
  - ✅ llms.txt 生成パイプライン完成（2025-12-05）
  - ✅ MCP Layer 情報統合完成（2025-12-05）
  - ✅ **task-entry.json スキーマ完成（2025-12-05）** 🎉 **NEW**
    - JSON Schema 定義完了
    - バリデータ実装完了
    - 変換スクリプト実装完了
    - ドキュメント完成
  - ⏳ Recipe 統合（Phase 2: 2025-12-06 予定）
- 🎉 ③ AI Interface 強化: **80%** ✨ **v1.1+ 完成**
  - ✅ Cortex OS v1.1+ 完成（5 MCP Servers）
  - ✅ Phase 2.5: Community Detection
  - ✅ Time MCP 完成（2025-12-05）- Automation Essential
  - ✅ `/diagnose` コマンド完成（2025-12-03）
  - ✅ `/ask` コマンド完成（2025-12-05、テスト済み）
  - ⏳ `/reflect`, `/plan`（未着手、オプショナル）

### Definition of Done (v1.2)

**必須条件（Minimum Viable Autonomy）**:
- [x] Recipe 13 稼働
- [x] Recipe 10 v1.2 稼働
- [x] データブリッジ完成
- [x] Slack 通知統合（Recipe 03 v1.2）
- [ ] 1週間の安定稼働（2025-12-03 → 2025-12-10）
  - 進捗: 3日目/7日間 ✅

**推奨条件（Full Autonomy）**:
- [x] 🎉 **Cortex OS v1.1 完成**（2025-12-05）
  - ✅ Filesystem MCP
  - ✅ Terminal MCP
  - ✅ Text Editor MCP
  - ✅ Search MCP
- [x] ⏰ **Time MCP 完成**（2025-12-05）- Automation Essential
  - ✅ Date/time calculations
  - ✅ Week/month range support
  - ✅ Essential for /brief, /wrap-up, weekly summary
- [x] llms-input.json パイプライン完成（2025-12-05）
- [x] llms.txt 生成パイプライン完成（2025-12-05）
- [x] MCP Layer 情報統合（2025-12-05）
- [x] **task-entry.json スキーマ完成（2025-12-05）** 🎉
- [ ] Recipe 統合（daily/weekly スキーマ適用）
- [x] `/diagnose` コマンド実装（2025-12-03完了、初回スコア80%）
- [x] `/ask` コマンド実装（2025-12-05完了、321行、4質問タイプ対応）

**オプション（Advanced Interface）**:
- [ ] `/reflect` コマンド
- [ ] `/plan` コマンド
- [ ] 月次 Summary
- [ ] AI 教師データ生成

### 次の3マイルストーン

**1. Slack 通知統合** ✅ 完了（2025-12-03）
- Recipe 03 に Slack DM 送信を追加
- 朝の brief 結果を自動通知
- フォーマット: "今日の3タスク + 所要時間 + バッファ"
- tomorrow.json との統合
- タグベース時間見積もり（⚡1.5h, 🎯2h, 通常1h）
- 20%バッファ計算

**2. 1週間の安定稼働確認**（7日間）
- 2025-12-03 → 2025-12-10
- 毎日の実行履歴を記録
- エラー率 < 5% を目標
- 現在: 1日目/7日間 ✅

**3. `/diagnose` コマンド実装** ✅ 完了（2025-12-03）
- Obsidian API 接続確認
- n8n ヘルスチェック
- digest ファイル存在確認
- TODO.md 構造検証
- KB Index 検証
- tomorrow.json 検証
- ヘルススコア算出（0-100%）
- レポート生成（Markdown）
- **初回実行**: 80% (Good ⚠️)

**4. 🎉 Cortex OS v1.1 完成** ✅ 完了（2025-12-05）
- 4 MCP Servers 実装完了
  - Filesystem MCP: Read knowledge files (8 tests ✅)
  - Terminal MCP: Execute pipelines (6 tests ✅)
  - Text Editor MCP: Write back to files (11 tests ✅)
  - Search MCP: Query Knowledge Graph + KB (10 tests ✅)
- Phase 2.5: MCP Community Detection (5 communities)
- 全 41 tests 通過
- 184 concepts, 838 KB chunks

**5. llms-input.json パイプライン完成** ✅ 完了（2025-12-05）
- Node.js pipeline 実装（generate-llms-input.mjs）
- Obsidian Codescript 実装（generateLlmsInput.cs.js）
- MCP Layer 情報統合（v1.1 metadata）
- llms-input-schema.md 完成
- 生成テスト成功（184 concepts, 5 clusters）

**6. ⏰ Time MCP 完成** ✅ 完了（2025-12-05）
- 6つのツール実装（get_current_time, add_time, format_date, get_week_range, get_month_range, date_diff）
- 全10テスト通過
- Cortex OS automation の必須ツール
- /brief, /wrap-up, Weekly Summary で活用
- パフォーマンス: <50ms 起動, <5ms 操作
- ゼロ依存（JavaScript Date API のみ）

---

## エピローグ：完全な自律へ — v2.0 への道

### v1.2 完成後の世界

v1.2 "Autonomy" が完成すると、こうなる：

**朝（08:00）**:
- Slack に「今日の3タスク」が届く
- TODO.md は既に最新
- 昨日の振り返りも整理済み

**昼（09:00 - 22:00）**:
- 作業に集中
- タスク完了を Obsidian でマーク
- システムは静かに観察

**夜（22:00）**:
- 自動で wrap-up 実行
- tomorrow.json 生成
- 明日の種が保存される

**深夜（03:00）**:
- KB 自動再構築
- 朝には全て検索可能

**人間がやること**:
- タスクを実行する
- 気づきを書く
- （たまに）`/diagnose` で健康確認

**それ以外は、全て自動。**

---

### v2.0 への展望

v1.2 は「自律」の第一歩。次の v2.0 では、さらに進化する：

**① 予測的インターフェース**:
- `/ask` が「聞く前に答える」
- 「今週はペースが遅い」と自動で警告
- 「このタスク、2日連続で繰越されてますよ」と通知

**② 学習する OS**:
- 過去の digest から「自分のパターン」を学習
- 「月曜は軽いタスクが良い」を自動検知
- 「金曜はレビュー作業が多い」を提案

**③ 長期記憶の活用**:
- 3ヶ月前の決定を思い出させる
- 「似た問題、前にどう解決した？」に答える
- 月次・四半期レポートを自動生成

**④ 外部連携**:
- カレンダーと統合（「明日 10時にミーティング、準備は？」）
- Slack と統合（「このタスク、誰かに相談する？」）
- GitHub と統合（「このタスク、Issue にする？」）

---

### 最後に：なぜ私たちはこれを作るのか

Cortex OS は「効率化ツール」ではない。

**これは、忘れないための仕組みだ。**

- 昨日の決意を、今日も覚えている
- 先週の気づきを、今週も活かす
- 去年の失敗を、今年は繰り返さない

人間の記憶は不完全だが、それでいい。

**システムが、覚えていてくれるから。**

---

**v1.2 "Autonomy" は、その第一歩。**

---

## Appendix

### 関連ドキュメント

- **v1.2 Roadmap**: [cortex/roadmap/v1.2-autonomy.md](../../cortex/roadmap/v1.2-autonomy.md)
- **Recipe 10 詳細**: [docs/recipes/recipe-10-tags.md](../recipes/recipe-10-tags.md)
- **Recipe 監視ガイド**: [docs/operations/recipe-monitoring.md](../operations/recipe-monitoring.md)
- **MCP Recipes 全体**: [docs/operations/mcp-recipes.md](../operations/mcp-recipes.md)
- **n8n 運用ガイド**: [docs/operations/n8n.md](../operations/n8n.md)

### 実装ファイル

- **Recipe 13**: `services/n8n/workflows/recipe-13-nightly-wrapup.json`
- **Recipe 03**: `services/n8n/workflows/recipe-03-daily-digest.json`
- **Recipe 10**: `services/n8n/workflows/recipe-10-todo-autosync.json`
- **Recipe 02**: `services/n8n/workflows/recipe-02-kb-rebuild.json`

### コマンド参照

**システム状態確認**:
```bash
# クイックチェック
curl -k -s https://127.0.0.1:27124/ | jq -r '.status'
docker ps --filter "name=n8n"
ls -lt cortex/daily/*.md | head -3

# 詳細チェック
bash docs/operations/recipe-monitoring.md  # スクリプト実行
```

**n8n UI**:
```
http://localhost:5678
```

---

**作成日**: 2025-11-28
**著者**: Cortex OS Development Team
**バージョン**: 1.0
**ステータス**: Living Document（継続更新）
