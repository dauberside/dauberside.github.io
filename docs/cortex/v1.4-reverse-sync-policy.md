# v1.4 Phase 2: é€†æ–¹å‘åŒæœŸãƒãƒªã‚·ãƒ¼

**Created**: 2025-12-08
**Status**: Draft â†’ Finalized
**Purpose**: digest ã‚’çµ¶å¯¾ã«å£Šã•ãªã„å®‰å…¨ãªé€†æ–¹å‘åŒæœŸã®å®Ÿè£…æ–¹é‡

---

## ğŸ¯ åŸºæœ¬åŸå‰‡

### Digest-First Philosophy

> **Digestï¼ˆäººé–“ã®è¨˜éŒ²ï¼‰ã¯å¸¸ã«æ­£ã§ã‚ã‚Šã€çµ¶å¯¾ã«ç ´å£Šã—ãªã„**

1. **Append-Only**: æ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸€åˆ‡ç·¨é›†ã—ãªã„
2. **New Content Only**: task-entry.json ã«ã®ã¿å­˜åœ¨ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ digest ã«è¿½åŠ 
3. **Preserve Structure**: digest ã®æ§‹é€ ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¶­æŒ
4. **Human Override**: äººé–“ãŒæ‰‹æ›¸ãã—ãŸå†…å®¹ã¯å¸¸ã«å„ªå…ˆ

---

## ğŸ“‹ é€†æ–¹å‘åŒæœŸã®ä»•æ§˜

### Input
- `task-entry-YYYY-MM-DD.json` ã® `completed` é…åˆ—

### Output
- `cortex/daily/YYYY-MM-DD-digest.md` ã® `## é€²æ—` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
1. Load digest markdown
   â†“
2. Parse existing tasks from ## é€²æ— section
   â†’ Extract task titles (é‡è¤‡æ¤œå‡ºç”¨)
   â†“
3. Load task-entry.json
   â†’ Get completed tasks
   â†“
4. Find new tasks (in task-entry but not in digest)
   â†’ Use title matching (exact match)
   â†“
5. Format new tasks in digest format
   â†’ ### Title (HH:MM JST)
   â†’ - **ã‚«ãƒ†ã‚´ãƒª**: ...
   â†’ - **æ‰€è¦æ™‚é–“**: ...
   â†’ - **ãƒ¡ãƒ¢**: ... (optional)
   â†“
6. Append new tasks to ## é€²æ— section (æœ«å°¾è¿½åŠ )
   â†“
7. Write back safely
   â†’ Preserve all existing content
   â†’ No line removal
   â†’ No existing block modification
```

---

## ğŸ”’ å®‰å…¨æ€§ãƒ«ãƒ¼ãƒ«

### Rule 1: No Destructive Operations

**ç¦æ­¢äº‹é …**:
- âŒ æ—¢å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚¯ã®ç·¨é›†
- âŒ æ—¢å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚¯ã®å‰Šé™¤
- âŒ æ—¢å­˜ã‚¿ã‚¹ã‚¯ã®ä¸¦ã³æ›¿ãˆ
- âŒ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸Šæ›¸ã
- âŒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ ã®å¤‰æ›´

**è¨±å¯äº‹é …**:
- âœ… `## é€²æ—` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ«å°¾ã«æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
- âœ… ã‚¿ã‚¹ã‚¯é–“ã®æ”¹è¡Œä¿æŒ
- âœ… ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ç©ºè¡Œä¿æŒ

### Rule 2: Duplicate Detection

**ãƒãƒƒãƒãƒ³ã‚°åŸºæº–**:
- ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
- å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥
- å‰å¾Œç©ºç™½ã¯ trim ã—ã¦æ¯”è¼ƒ

**é‡è¤‡åˆ¤å®š**:
```python
def is_duplicate(new_task_title: str, existing_titles: Set[str]) -> bool:
    return new_task_title.strip() in existing_titles
```

### Rule 3: Insert Position

**æŒ¿å…¥ä½ç½®**: `## é€²æ—` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®**æœ«å°¾**

**ç†ç”±**:
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é †ã‚½ãƒ¼ãƒˆã¯è¤‡é›‘ï¼ˆæ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ç§»å‹•ã®ãƒªã‚¹ã‚¯ï¼‰
- æœ«å°¾è¿½åŠ ã¯æœ€ã‚‚å®‰å…¨ï¼ˆæ—¢å­˜å†…å®¹ã«å½±éŸ¿ãªã—ï¼‰
- äººé–“ãŒå¾Œã§ä¸¦ã³æ›¿ãˆå¯èƒ½

**å®Ÿè£…**:
```python
# Find ## é€²æ— section end position
progress_end = find_section_end("## é€²æ—", digest_content)

# Insert new tasks before next section or EOF
new_content = digest_content[:progress_end] + new_tasks_formatted + digest_content[progress_end:]
```

### Rule 4: Format Consistency

**ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚¯å½¢å¼**:
```markdown
### ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« (HH:MM JST)
- **ã‚«ãƒ†ã‚´ãƒª**: category-name
- **æ‰€è¦æ™‚é–“**: XXm
- **ãƒ¡ãƒ¢**: optional memo text
```

**å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ`title`ï¼‰
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆ`timestamp`ï¼‰
- ã‚«ãƒ†ã‚´ãƒªï¼ˆ`category`ï¼‰
- æ‰€è¦æ™‚é–“ï¼ˆ`duration`ï¼‰

**ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- ãƒ¡ãƒ¢ï¼ˆ`memo`ï¼‰

**æ”¹è¡Œãƒ«ãƒ¼ãƒ«**:
- ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚¯é–“: 1ç©ºè¡Œ
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“: 2ç©ºè¡Œ

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### Test 1: Append New Task
```python
def test_sync_tasks_to_digest_append_new():
    """æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’ digest ã«è¿½åŠ """
    # Given: digest ã«æ—¢å­˜ã‚¿ã‚¹ã‚¯1ä»¶
    digest = """
## é€²æ—

### æ—¢å­˜ã‚¿ã‚¹ã‚¯ (10:00 JST)
- **ã‚«ãƒ†ã‚´ãƒª**: core-work
- **æ‰€è¦æ™‚é–“**: 30m

## Reflection
"""

    # Given: task-entry ã«æ—¢å­˜+æ–°è¦ã‚¿ã‚¹ã‚¯
    task_entry = {
        "completed": [
            {"content": "æ—¢å­˜ã‚¿ã‚¹ã‚¯", "category": "core-work", ...},
            {"content": "æ–°è¦ã‚¿ã‚¹ã‚¯", "category": "admin", ...}
        ]
    }

    # When: sync_tasks_to_digest() å®Ÿè¡Œ

    # Then: æ–°è¦ã‚¿ã‚¹ã‚¯ãŒè¿½åŠ ã•ã‚Œã‚‹
    assert "### æ–°è¦ã‚¿ã‚¹ã‚¯" in result
    assert "### æ—¢å­˜ã‚¿ã‚¹ã‚¯" in result  # æ—¢å­˜ã‚¿ã‚¹ã‚¯ã¯ä¿æŒ
    assert result.index("æ—¢å­˜ã‚¿ã‚¹ã‚¯") < result.index("æ–°è¦ã‚¿ã‚¹ã‚¯")  # é †åºä¿æŒ
```

### Test 2: No Duplicate
```python
def test_sync_tasks_to_digest_no_duplicate():
    """é‡è¤‡ã‚¿ã‚¹ã‚¯ã¯è¿½åŠ ã—ãªã„"""
    # Given: digest ã¨ task-entry ã«åŒã˜ã‚¿ã‚¹ã‚¯
    # When: sync å®Ÿè¡Œ
    # Then: ã‚¿ã‚¹ã‚¯ã¯1å›ã®ã¿å­˜åœ¨
    assert digest.count("### åŒã˜ã‚¿ã‚¹ã‚¯") == 1
```

### Test 3: Preserve Existing Content
```python
def test_sync_tasks_to_digest_preserve_existing():
    """æ—¢å­˜ã®æ‰‹æ›¸ããƒ¡ãƒ¢ã‚’ä¿æŒ"""
    # Given: digest ã«æ‰‹æ›¸ããƒ¡ãƒ¢ã‚ã‚Š
    digest = """
## é€²æ—

æ‰‹æ›¸ããƒ¡ãƒ¢ï¼šä»Šæ—¥ã¯èª¿å­ãŒè‰¯ã„

### æ—¢å­˜ã‚¿ã‚¹ã‚¯ (10:00 JST)
- **ã‚«ãƒ†ã‚´ãƒª**: core-work
- **æ‰€è¦æ™‚é–“**: 30m
"""

    # When: sync å®Ÿè¡Œ
    # Then: æ‰‹æ›¸ããƒ¡ãƒ¢ãŒæ¶ˆãˆãªã„
    assert "æ‰‹æ›¸ããƒ¡ãƒ¢ï¼šä»Šæ—¥ã¯èª¿å­ãŒè‰¯ã„" in result
```

### Test 4: Handle Missing Section
```python
def test_sync_tasks_to_digest_missing_section():
    """## é€²æ— ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã®å‡¦ç†"""
    # Given: digest ã« ## é€²æ— ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãªã—
    # When: sync å®Ÿè¡Œ
    # Then: ã‚¨ãƒ©ãƒ¼ or ã‚»ã‚¯ã‚·ãƒ§ãƒ³è‡ªå‹•ä½œæˆ
    # æ–¹é‡: ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ï¼ˆdigest ã®æ§‹é€ ã‚’å‹æ‰‹ã«å¤‰æ›´ã—ãªã„ï¼‰
```

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### Before (Phase 1)
- digest â†’ task-entry (ç‰‡æ–¹å‘ã®ã¿)
- task-entry ã¯ digest ã®è¨˜éŒ²ã®ã¿åæ˜ 
- `/log` ã‚³ãƒãƒ³ãƒ‰ã§è¨˜éŒ²ã—ãŸã‚¿ã‚¹ã‚¯ã®ã¿åŒæœŸ

### After (Phase 2 å®Œæˆ)
- digest â†” task-entry (åŒæ–¹å‘)
- `/wrap-up` ã‚„ Analytics ãŒç”Ÿæˆã—ãŸ task-entry ã‚‚ digest ã«åæ˜ 
- digest ãŒå®Œå…¨ãª "Single Source of Truth" ã«ãªã‚‹

---

## ğŸš€ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Step 1: ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°å®Ÿè£…
```python
def get_digest_task_titles(digest_content: str) -> Set[str]:
    """Extract existing task titles from ## é€²æ— section"""
    pass

def find_section_end(section_name: str, content: str) -> int:
    """Find the end position of a markdown section"""
    pass

def format_task_for_digest(task: Dict) -> str:
    """Format a task dict into digest markdown format"""
    pass
```

### Step 2: ãƒ¡ã‚¤ãƒ³é–¢æ•°å®Ÿè£…
```python
def sync_tasks_to_digest(date: str, task_entry: Dict, digest_path: Path) -> bool:
    """Sync tasks.json â†’ digest (append-only, digest-safe)"""
    pass
```

### Step 3: ãƒ†ã‚¹ãƒˆå®Ÿè£…
- `tests/scripts/test_log_note.py` ã«è¿½åŠ 
- ä¸Šè¨˜ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1-4ã‚’å®Ÿè£…

### Step 4: main() çµ±åˆ
```python
def main():
    # ... existing code ...

    # Bidirectional sync
    changed_digest_to_tasks = sync_digest_to_tasks(...)
    changed_tasks_to_digest = sync_tasks_to_digest(...)

    if changed_digest_to_tasks or changed_tasks_to_digest:
        print("âœ… Bidirectional sync complete!")
```

---

## âœ… å®Œæˆæ¡ä»¶

- [ ] `sync_tasks_to_digest()` é–¢æ•°å®Ÿè£…
- [ ] ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°å®Ÿè£…ï¼ˆ3ã¤ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4ã¤ passing
- [ ] å®Ÿæˆ¦ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿéš›ã® digest ã§å‹•ä½œç¢ºèªï¼‰
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆREADME, v1.4-roadmap.mdï¼‰

---

**Status**: Policy Finalized âœ…
**Next**: Implementation (1-1.5 hours)
