# v1.4 Incomplete Task Detection Spec

**Last Updated**: 2025-12-08  
**Status**: Draft (Phase 3 Start)  
**Owner**: Cortex OS

---

## 1. Purpose / Goal

### 1.1 ç›®çš„

- 1æ—¥ã®çµ‚ã‚ã‚Šã«ã€Œ**ã‚„ã‚Šæ®‹ã—ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ã§æ´—ã„å‡ºã™**ã€ä»•çµ„ã¿ã‚’ä½œã‚‹ã€‚
- æ´—ã„å‡ºã—ãŸæœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ã€ç¿Œæ—¥ä»¥é™ã®è¨ˆç”»ï¼ˆ`tomorrow_candidates` / carryoverï¼‰ã«è‡ªç„¶ã«å¼•ãç¶™ã’ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
- å°†æ¥ã® **Weekly Intelligence / Predictive Intelligence** ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã€
  - ã€Œè¨ˆç”» vs å®Ÿç¸¾ã€
  - ã€Œå®Œäº†ç‡ã€ã€Œæ”¾ç½®ã‚¿ã‚¹ã‚¯ã€
  ã‚’å®‰å®šã—ã¦å–ã‚Œã‚‹çŠ¶æ…‹ã«ã™ã‚‹ã€‚

### 1.2 éã‚´ãƒ¼ãƒ«

- ã‚¿ã‚¹ã‚¯å†…å®¹ã®è‡ªå‹•ä¿®æ­£ãƒ»è‡ªå‹•å„ªå…ˆåº¦æ±ºå®šã¯ã—ãªã„ï¼ˆv1.4 ã§ã¯ã‚µã‚¸ã‚§ã‚¹ãƒˆãªã—ï¼‰ã€‚
- TODO.md ã‚„å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“ã§ã¯æ‰±ã‚ãªã„ï¼ˆæ—¢å­˜ Recipe ã®è²¬å‹™ï¼‰ã€‚
- ã€Œå®Œäº†ã®åˆ¤æ–­ã€ã‚’ AI ãŒæ¨è«–ã™ã‚‹ã“ã¨ï¼ˆv1.4 ã§ã¯ **æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå˜ç´”ãƒ­ã‚¸ãƒƒã‚¯**ï¼‰ã€‚

---

## 2. Inputs & Data Model

### 2.1 å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

- `cortex/state/task-entry-YYYY-MM-DD.json`
- å°†æ¥çš„ã«å‚ç…§ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€v1.4 ã§ã¯å¿…é ˆã§ã¯ãªã„ã‚‚ã®:
  - `cortex/daily/YYYY-MM-DD-digest.md`ï¼ˆäººé–“ã®è¨˜è¿°ãŒä¸»ï¼‰

### 2.2 task-entry JSON ã‚¹ã‚­ãƒ¼ãƒï¼ˆç¾çŠ¶ï¼‰

```jsonc
{
  "date": "2025-12-08",
  "tasks": [/* è¨ˆç”»ã‚¿ã‚¹ã‚¯ï¼ˆå°†æ¥åˆ©ç”¨äºˆå®š or Recipeã‹ã‚‰æŠ•å…¥ï¼‰ */],
  "completed": [
    {
      "content": "v1.4 Phase 1 å®Ÿè£…",
      "status": "completed",
      "category": "core-work",
      "duration": "30m",
      "timestamp": "13:31",
      "memo": "log/note ã‚³ãƒãƒ³ãƒ‰ä½œæˆ"
    }
  ],
  "carryover": [],
  "reflection": "",
  "tomorrow_candidates": [],
  "metadata": {
    "generated_at": "2025-12-08T05:01:48.417906+00:00",
    "source": "sync-digest-tasks",
    "version": "1.0.0",
    "updated_at": "2025-12-08T05:02:00.792823+00:00"
  }
}
```

### 2.3 ãƒ­ã‚¸ãƒƒã‚¯ãŒä¾å­˜ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

- `tasks`: ã€Œãã®æ—¥ã« ã‚„ã‚‹ã¤ã‚‚ã‚Šã ã£ãŸ or ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã•ã‚ŒãŸã€ã‚¿ã‚¹ã‚¯ä¸€è¦§
  - `content`: ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚­ãƒ¼æ‰±ã„ï¼‰
- `completed`: ã€Œå®Ÿéš›ã«å®Œäº†ã—ãŸã€ã‚¿ã‚¹ã‚¯ä¸€è¦§
  - `content`: ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚­ãƒ¼æ‰±ã„ï¼‰
  - `status`: "completed" ã‚’æƒ³å®š
- `carryover`: å‰æ—¥ã‹ã‚‰ã®æŒã¡è¶Šã—ã‚¿ã‚¹ã‚¯ï¼ˆv1.4 ã§ã¯å‚è€ƒæ‰±ã„ï¼‰
- `tomorrow_candidates`: ç¿Œæ—¥ã«æŒã¡è¶Šã™å€™è£œï¼ˆã“ã“ã«æ›¸ãå‡ºã™ï¼‰

---

## 3. Detection Logic

### 3.1 åŸºæœ¬æ–¹é‡

1. ã€Œã‚„ã‚‹ã¤ã‚‚ã‚Šã ã£ãŸã€ã‚¿ã‚¹ã‚¯é›†åˆ ã¨
2. ã€Œå®Ÿéš›ã«å®Œäº†ã—ãŸã€ã‚¿ã‚¹ã‚¯é›†åˆ ã®å·®åˆ†ã‚’å–ã‚Šã€
â†’ ãã®æ—¥ã«å®Œäº†ã—ãªã‹ã£ãŸã‚¿ã‚¹ã‚¯ = æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã¨ã—ã¦æ‰±ã†ã€‚

### 3.2 ã‚¿ã‚¹ã‚¯åŒä¸€æ€§ã®å®šç¾©

- v1.4 ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã« `content` ã®å®Œå…¨ä¸€è‡´ ã‚’ã€ŒåŒä¸€ã‚¿ã‚¹ã‚¯ã€ã¨ã¿ãªã™ã€‚
- å¤§æ–‡å­—å°æ–‡å­—ãƒ»å…¨è§’åŠè§’ã®å·®ã¯ ãã®ã¾ã¾å³å¯†ä¸€è‡´ï¼ˆå°†æ¥çš„ã« fuzzy match æ‹¡å¼µã®ä½™åœ°ã‚’æ®‹ã™ï¼‰ã€‚

```python
planned_titles   = {t["content"].strip() for t in task_entry["tasks"]}
completed_titles = {t["content"].strip() for t in task_entry["completed"]}
incomplete_titles = planned_titles - completed_titles
```

### 3.3 åˆ¤å®šå¯¾è±¡

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `tasks` ã«è¼‰ã£ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã ã‘ ã‚’åˆ¤å®šå¯¾è±¡ã¨ã™ã‚‹ã€‚
- å°†æ¥æ‹¡å¼µ: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ `carryover` ã‚’ã€Œæš—é»™ã®è¨ˆç”»ã€ã¨ã¿ãªã—åˆ¤å®šå¯¾è±¡ã«å«ã‚ã‚‹ã€‚

### 3.4 æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®æŠ½å‡º

```python
def detect_incomplete_tasks(task_entry: dict) -> dict:
    """
    å…¥åŠ›: å˜ä¸€æ—¥ã® task-entry JSON
    å‡ºåŠ›:
    {
      "date": "2025-12-08",
      "planned": 5,
      "completed": 3,
      "incomplete": 2,
      "completion_rate": 0.6,
      "incomplete_tasks": [
        { ... ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ... },
        ...
      ]
    }
    """
```

- `incomplete_tasks` ã«ã¯ã€å…ƒã® `tasks` ã«ã‚ã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾ or å¿…è¦æœ€å°é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚

---

## 4. Output & Integration

### 4.1 é–¢æ•°ãƒ¬ãƒ™ãƒ«ã®å‡ºåŠ›

- `detect_incomplete_tasks(date: str) -> dict`
- ä¸Šè¨˜ 3.4 ã®æˆ»ã‚Šå€¤ã‚’è¿”ã™ã€‚

### 4.2 task-entry ã¸ã®æ›¸ãæˆ»ã—

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã§ `task-entry-YYYY-MM-DD.json` ã‚’æ›´æ–°ã™ã‚‹ï¼š

1. `incomplete_tasks` ã‚’ `task_entry["carryover"]` ã«ä¿å­˜ã™ã‚‹ï¼ˆv1.4ã§ã¯ã“ã“ã«æ ¼ç´ï¼‰
2. ç¿Œæ—¥ã® `task-entry-YYYY-MM-DD.json` ã¾ãŸã¯ `tomorrow_candidates` ã¸è»¢è¨˜ã™ã‚‹ã®ã¯ åˆ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼ ã¨ã™ã‚‹
   - ä¾‹: `scripts/rollover-tasks.py` or nightly Recipe ã®è²¬å‹™

```python
task_entry["carryover"] = incomplete_tasks
task_entry["metadata"]["incomplete_detection"] = {
    "version": "1.0.0",
    "detected_at": "<ISO timestamp>",
    "planned": ...,
    "completed": ...,
    "incomplete": ...,
    "completion_rate": ...
}
```

### 4.3 /wrap-up / Nightly Recipe ã¨ã®é€£æº

**æ‰‹å‹•**: `/wrap-up` ã‚³ãƒãƒ³ãƒ‰ãŒã“ã‚Œã‚’å‘¼ã³å‡ºã™ã‚¤ãƒ¡ãƒ¼ã‚¸
- `/wrap-up` å†…ã§:
  - `detect_incomplete_tasks(today)` ã‚’å®Ÿè¡Œ
  - digest ã®ã€ŒæŒ¯ã‚Šè¿”ã‚Šã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å®Œäº†ç‡ã‚µãƒãƒªã‚’æ›¸ãè¶³ã™ï¼ˆä»»æ„ï¼‰
  - `carryover` ã«çµæœã‚’æ›¸ãæˆ»ã—

**è‡ªå‹•**: Nightly Recipe (22:00 JST) ãŒåŒã˜å‡¦ç†ã‚’å‘¼ã¶
- å¤±æ•—æ™‚ã¯:
  - `task-entry` ã¯å¤‰æ›´ã•ã‚Œãªã„
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ï¼ˆv1.4ã§ã¯ãƒ­ã‚°ã« WARN ã‚’æ®‹ã™ã®ã¿ï¼‰

---

## 5. Error Handling & Edge Cases

### 5.1 ç•°å¸¸ç³»ï¼ˆv1.4ã§æœ€ä½é™å¯¾å¿œï¼‰

**å£Šã‚ŒãŸ JSON / ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼**:
- `task-entry-YYYY-MM-DD.json` ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ãŸå ´åˆ:
  - ä¾‹å¤–ã‚’æ¡ã‚Šæ½°ã•ãš `SystemExit(1)` or æ˜ç¤ºçš„ãªã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§çµ‚äº†
  - æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã«ã‚ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
  - `âŒ Failed to load task-entry-YYYY-MM-DD.json: JSONDecodeError ...`

**å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ å¦‚**:
- `tasks` / `completed` ãŒ list ã§ãªã„å ´åˆ:
  - å®‰å…¨å´ã«å€’ã—ã¦ã€Œã‚¿ã‚¹ã‚¯ 0 ä»¶ã€ã¨ã¿ãªã™ & WARN ãƒ­ã‚°å‡ºåŠ›
- å„ã‚¿ã‚¹ã‚¯ã« `content` ãŒãªã„å ´åˆ:
  - ãã®ã‚¿ã‚¹ã‚¯ã¯åˆ¤å®šå¯¾è±¡ã‹ã‚‰é™¤å¤–ã—ã€WARN ãƒ­ã‚°å‡ºåŠ›

### 5.2 ç«¶åˆã‚±ãƒ¼ã‚¹ï¼ˆv1.4ã§ã¯ã€Œéå¯¾å¿œã‚’æ˜ç¤ºã€ï¼‰

- åŒã˜æ—¥ä»˜ã® `task-entry` ã‚’ è¤‡æ•°ãƒ—ãƒ­ã‚»ã‚¹ãŒåŒæ™‚æ›´æ–°ã—ãŸå ´åˆã®ç«¶åˆè§£æ±ºã¯ v1.4 ã§ã¯æ‰±ã‚ãªã„ã€‚
- å°†æ¥å¯¾å¿œæ¡ˆ:
  - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯
  - `metadata["updated_at"]` ã‚’ä½¿ã£ãŸ CAS çš„æŒ™å‹•

---

## 6. CLI Interface

### 6.1 ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

æ–°è¦: `scripts/detect-incomplete-tasks.py`

```bash
# ä»Šæ—¥ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯æ¤œå‡º
python scripts/detect-incomplete-tasks.py

# ç‰¹å®šæ—¥ä»˜
python scripts/detect-incomplete-tasks.py 2025-12-08
```

### 6.2 å‹•ä½œä»•æ§˜

1. å¼•æ•° `date` ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã° JST ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨ï¼ˆ`sync-digest-tasks.py` ã¨åŒæ§˜ï¼‰ã€‚
2. `cortex/state/task-entry-YYYY-MM-DD.json` ã‚’ãƒ­ãƒ¼ãƒ‰ã€‚
3. `detect_incomplete_tasks()` ã‚’å®Ÿè¡Œã€‚
4. çµæœã‚’:
   - `carryover` + `metadata.incomplete_detection` ã«æ›¸ãæˆ»ã™ã€‚
   - æ¨™æº–å‡ºåŠ›ã«ã‚µãƒãƒªã‚’è¡¨ç¤ºï¼ˆä¾‹ï¼‰:

```
ğŸ” Incomplete tasks for 2025-12-08

  Planned:   5
  Completed: 3
  Incomplete: 2
  Completion rate: 60%

  - [ ] ã‚¿ã‚¹ã‚¯A
  - [ ] ã‚¿ã‚¹ã‚¯B

ğŸ’¾ Updated: cortex/state/task-entry-2025-12-08.json
```

---

## 7. Testing

### 7.1 ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

- `tests/scripts/test_incomplete_tasks.py`ï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«æ¨å¥¨ï¼‰

### 7.2 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

1. **åŸºæœ¬ã‚±ãƒ¼ã‚¹**
   - tasks: 3ä»¶
   - completed: 2ä»¶ï¼ˆã†ã¡ 2ä»¶ã¯ tasks ã«å«ã¾ã‚Œã‚‹ï¼‰
   - â†’ incomplete = 1ä»¶ / completion_rate = 2/3

2. **å®Œäº†ç‡ 100%**
   - tasks ã¨ completed ãŒå®Œå…¨ä¸€è‡´ â†’ incomplete 0ä»¶ / rate = 1.0

3. **å®Œäº†ç‡ 0%**
   - completed ãŒç©º â†’ incomplete = len(tasks) / rate = 0.0

4. **content æ¬ å¦‚ã‚¿ã‚¹ã‚¯**
   - tasks ã« `{"category": "core-work"}` ã ã‘ã®ã‚¿ã‚¹ã‚¯ãŒæ··ã–ã‚‹
   - â†’ ãã®ã‚¿ã‚¹ã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ— & WARN ãƒ­ã‚°

5. **å£Šã‚ŒãŸ JSON**
   - ä¸æ­£ãª JSON ã® task-entry ã‚’æ¨¡æ“¬
   - â†’ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ SystemExit or ä¾‹å¤–ã‚’æŠ•ã’ã€ãƒ—ãƒ­ã‚»ã‚¹ãŒå¤±æ•—çµ‚äº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

6. **ç©ºã® task-entry**
   - tasks ã‚‚ completed ã‚‚ç©º â†’ incomplete 0ä»¶ / rate = NaN or 0.0
   - å®Ÿè£…ä¸Šã¯ 0é™¤ç®—ã‚’é¿ã‘ã¦ 0.0 æ‰±ã„ã«ã™ã‚‹æƒ³å®š

---

## 8. ä»Šå¾Œã®æ‹¡å¼µä½™åœ°

- `carryover` ã‹ã‚‰ç¿Œæ—¥ã® `tasks` / `tomorrow_candidates` ã¸è‡ªå‹•è»¢è¨˜ã™ã‚‹ rollover ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
- mood/energy ã‚¹ã‚³ã‚¢ã¨ã®çµ„ã¿åˆã‚ã›:
  - mood ãŒä½ã„æ—¥ã®å®Œäº†ç‡ / ã‚¿ã‚¹ã‚¯è² è·åˆ†æã€‚
- Weekly Intelligence ã§ã®åˆ©ç”¨:
  - ä¸€é€±é–“ã®å®Œäº†ç‡ãƒˆãƒ¬ãƒ³ãƒ‰
  - ã€Œæ…¢æ€§çš„ã« carryover ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã€ã®æ¤œå‡º
- ã‚¿ã‚¹ã‚¯åŒä¸€æ€§ã® fuzzy matching:
  - content é¡ä¼¼åº¦ / æ­£è¦åŒ–ï¼ˆå…¨è§’åŠè§’ãƒ»è¨˜å·é™¤å»ãªã©ï¼‰

---

**Status**: Spec Complete - Ready for Implementation ğŸš€  
**Next**: `scripts/detect-incomplete-tasks.py` + tests
