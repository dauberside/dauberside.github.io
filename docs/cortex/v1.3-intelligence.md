# Cortex OS v1.3 "Intelligence" — 予測と学習の物語

**第二の脳から、思考するパートナーへ**

---

## はじめに：自律の先にあるもの

v1.2 "Autonomy" で、Cortex OS は **自律** を手に入れた：
- 人が忘れても、システムは動き続ける
- 人が眠っても、ループは回り続ける
- 人が問えば、システムは答える

しかし、それは「**記録と再生**」に留まっていた。

**v1.3 "Intelligence" の問い**：
> システムは記録するだけでなく、**学習**できるか？  
> 過去のパターンから、**未来を予測**できるか？  
> ユーザーの行動を理解し、**先回りして提案**できるか？

これは「**知能**」の始まりだ。

---

## 第1章：v1.2 までの限界

### できること（v1.2）

| 機能 | 説明 |
|------|------|
| **記録** | Daily Digest, Weekly Summary を自動生成 |
| **想起** | `/ask` で過去のデータを検索・要約 |
| **実行** | `/wrap-up`, `/brief` でタスクを構造化 |
| **自律** | Cron で 22:00, 03:00, 08:00 に自動実行 |

### できないこと（v1.2 の限界）

1. **パターン認識がない**
   - 「いつも水曜は集中できない」→ 気づけない
   - 「このタスクはいつも遅れる」→ 警告できない

2. **予測ができない**
   - 「明日は忙しくなりそう」→ 判断できない
   - 「このタスクは3日かかる」→ 見積もれない

3. **学習しない**
   - 同じミスを繰り返す
   - フィードバックループがない

4. **文脈が浅い**
   - 過去30日のデータしか見ていない
   - 長期的なトレンドを捉えられない

---

## 第2章：v1.3 "Intelligence" の設計思想

### ビジョン：Cortex OS が「考える」とは？

**3つの知能レイヤー**を構築する：

```
┌─────────────────────────────────────┐
│  Layer 3: Predictive Intelligence   │ ← 未来予測
│  - タスク所要時間の予測              │
│  - 負荷の事前警告                    │
│  - 最適なスケジュール提案             │
└─────────────────────────────────────┘
           ↓ フィードバック
┌─────────────────────────────────────┐
│  Layer 2: Pattern Recognition       │ ← パターン学習
│  - 曜日別の生産性パターン            │
│  - タスク完了までの実績データ         │
│  - リズム・習慣の可視化               │
└─────────────────────────────────────┘
           ↓ データ蓄積
┌─────────────────────────────────────┐
│  Layer 1: Memory & Context (v1.2)   │ ← 記録と想起
│  - Daily/Weekly ループ               │
│  - KB embeddings                    │
│  - /ask, /diagnose                  │
└─────────────────────────────────────┘
```

---

## 第3章：3本柱の設計

### ① Temporal Analytics — 時間軸での学習

**目的**：過去のパターンから、時間の使い方を学習する

#### 実装する機能

1. **Workload Heatmap**（負荷ヒートマップ）
   ```
   月  火  水  木  金  土  日
   🟢 🟡 🔴 🟡 🟢 ⚪ ⚪  ← 過去4週の平均負荷
   ```
   - 曜日ごとの平均タスク数・完了率
   - 「水曜は要注意」を自動検出

2. **Task Duration Learning**（タスク所要時間学習）
   ```json
   {
     "task_type": "blog_writing",
     "historical_durations": [120, 180, 150],
     "predicted_duration": 150,
     "confidence": 0.85
   }
   ```
   - タスクタイプごとの実績データ
   - 次回の所要時間を予測

3. **Rhythm Detection**（リズム検出）
   - 「朝型」「夜型」を自動判定
   - 「週末に溜める癖」を検出
   - 最適な作業時間を提案

#### データソース
- `cortex/daily/*.md` の `tasks` セクション
- `cortex/state/tomorrow.json` の完了状態
- Git commit timestamps

#### 実装方針
- **ツール**: Python (pandas, matplotlib)
- **出力**: `cortex/analytics/temporal-patterns.json`
- **UI**: Obsidian Canvas に可視化

---

### ② Adaptive Task Management — 賢いタスク管理

**目的**：タスクを理解し、最適な順序・タイミングを提案する

#### 実装する機能

1. **Smart Prioritization**（スマート優先度調整）
   ```
   Before:  #high, #medium, #low
   After:   #urgent-high (deadline 2日), #defer-low (負荷高)
   ```
   - Deadline と負荷を考慮
   - 「今週は厳しい → このタスクは来週に」

2. **Context-Aware Suggestions**（文脈認識提案）
   ```
   User: "今日何する？"
   Cortex: "水曜は集中が落ちやすいです。
            軽めのタスクを3つ提案します：
            1. Issue #42 レビュー (15分)
            2. ドキュメント更新 (30分)
            3. メール返信 (20分)"
   ```

3. **Dependency Detection**（依存関係検出）
   - タスク間の依存を自動推論
   - 「A が完了しないと B はできない」を警告

#### データソース
- `TODO.md` + `cortex/state/tomorrow.json`
- `/ask` で取得した過去のタスク関連性
- KB embeddings での意味的類似度

#### 実装方針
- **ツール**: TypeScript + LLM (Claude/GPT-4)
- **API**: 新しい `/suggest` コマンド
- **統合**: Recipe 10 (TODO Auto-sync) に組み込み

---

### ③ Self-Improvement Loop — 自己改善ループ

**目的**：システム自身が、自分のパフォーマンスを監視・改善する

#### 実装する機能

1. **Health Score**（健康スコア）
   ```
   Cortex OS Health: 87/100
   - ✅ 7日連続で正常稼働 (+10)
   - ⚠️ KB rebuild が1回失敗 (-5)
   - ✅ TODO 同期率 95% (+8)
   - ⚠️ Weekly Summary が未生成 (-6)
   ```

2. **Feedback Collection**（フィードバック収集）
   ```
   /wrap-up で毎晩:
   Q: "今日の Cortex OS のサポートは役立ちましたか？"
   A: 😊 / 😐 / 😞
   ```
   - ユーザー満足度のトラッキング
   - 改善点の自動検出

3. **Recipe Performance Monitoring**（Recipe パフォーマンス監視）
   - 各 Recipe の実行時間・成功率
   - ボトルネックの検出
   - 「Recipe 03 が遅い → 最適化提案」

#### データソース
- n8n execution logs (`/api/v1/executions`)
- Slack notification timestamps
- Git commit frequency

#### 実装方針
- **ツール**: Python (analytics) + n8n (monitoring)
- **出力**: `cortex/analytics/system-health.json`
- **通知**: 週次で Slack にレポート送信

---

## 第4章：技術スタック

### 新規導入するツール

| ツール | 用途 | 理由 |
|-------|------|------|
| **pandas** | 時系列データ分析 | 過去データの集約・可視化 |
| **scikit-learn** | 簡易機械学習 | タスク所要時間の回帰予測 |
| **Obsidian Dataview** | Canvas 可視化 | ヒートマップを vault に表示 |
| **Claude API** | 自然言語理解 | タスク依存関係の推論 |

### データフロー

```
┌──────────────┐
│ Daily Digest │ ← Markdown
└──────┬───────┘
       ↓ parse
┌──────────────┐
│ JSON Events  │ ← task_entry.json
└──────┬───────┘
       ↓ aggregate
┌──────────────┐
│ Analytics DB │ ← SQLite (optional)
└──────┬───────┘
       ↓ analyze
┌──────────────┐
│ Insights     │ → /suggest, /predict
└──────────────┘
```

---

## 第5章：実装計画

### Phase 1: Temporal Analytics（3-4日）

**目標**: 過去のデータを可視化し、パターンを発見する

**タスク**:
1. [ ] 過去30日分の Daily Digest から task data を抽出
2. [ ] Workload Heatmap 生成スクリプト
3. [ ] Task Duration 統計計算
4. [ ] Obsidian Canvas への出力

**成果物**:
- `scripts/analyze-temporal-patterns.py`
- `cortex/analytics/temporal-patterns.json`
- `cortex/canvas/workload-heatmap.canvas`

**完了条件**:
- 曜日別の負荷が可視化される
- 「水曜が危険」のような洞察が得られる

---

### Phase 2: Smart Task Suggestions（4-5日）

**目標**: タスクを理解し、最適な順序を提案する

**タスク**:
1. [ ] `/suggest` コマンド実装
2. [ ] Task dependency 推論ロジック
3. [ ] Context-aware priority 調整
4. [ ] Recipe 10 統合（TODO Auto-sync）

**成果物**:
- `.claude/commands/suggest.md`
- `scripts/smart-task-suggester.ts`
- Recipe 10 v1.3 update

**完了条件**:
- `/suggest` が曜日・負荷を考慮した提案を返す
- TODO.md に priority が自動調整される

---

### Phase 3: Self-Improvement Loop（3-4日）

**目標**: システムが自分を監視し、改善提案を出す

**タスク**:
1. [ ] Health Score 計算ロジック
2. [ ] Feedback collection (wrap-up 統合)
3. [ ] Recipe performance monitoring
4. [ ] Weekly health report (Slack)

**成果物**:
- `scripts/calculate-health-score.py`
- `cortex/analytics/system-health.json`
- Recipe 11 v1.3 update (health report 追加)

**完了条件**:
- 毎週日曜に Health Report が Slack に届く
- スコアが 80 未満で警告が出る

---

### Phase 4: Integration & Polish（2-3日）

**目標**: 全体を統合し、ドキュメントを整備する

**タスク**:
1. [ ] 3つの機能を `/diagnose` に統合
2. [ ] v1.3 ドキュメント完成
3. [ ] テスト・バグ修正
4. [ ] 1週間の安定稼働確認

**成果物**:
- `docs/cortex/v1.3-intelligence.md` (このファイル)
- Updated README.md
- Updated CLAUDE.md

**完了条件**:
- v1.3 の全機能が稼働
- ドキュメントが最新状態

---

## 第6章：成功指標

### Definition of Done (v1.3)

v1.3 は以下を満たしたとき「完成」とする：

#### 必須要件（Must Have）

- [ ] **Temporal Analytics 稼働**
  - Workload Heatmap が生成される
  - Task Duration 予測が機能する
  
- [ ] **Smart Suggestions 稼働**
  - `/suggest` が文脈を理解した提案を返す
  - Priority が自動調整される
  
- [ ] **Health Monitoring 稼働**
  - 毎週 Health Report が届く
  - システムが自己診断できる

- [ ] **7日間の安定稼働**
  - エラーなく全ループが回る
  - データの欠損がない

#### 推奨要件（Should Have）

- [ ] Obsidian Canvas での可視化
- [ ] Task dependency 検出
- [ ] Feedback ループの実装

#### オプション要件（Nice to Have）

- [ ] SQLite でのデータ永続化
- [ ] 機械学習モデルの導入
- [ ] A/B テストによる最適化

---

## 第7章：スケジュール

### タイムライン（15-20日）

```
Week 1 (12/09-12/15): Phase 1 + Phase 2
  ├─ 12/09-12/12: Temporal Analytics
  └─ 12/13-12/15: Smart Suggestions 着手

Week 2 (12/16-12/22): Phase 2 + Phase 3
  ├─ 12/16-12/18: Smart Suggestions 完成
  └─ 12/19-12/22: Self-Improvement Loop

Week 3 (12/23-12/29): Phase 4 + 安定化
  ├─ 12/23-12/25: Integration
  └─ 12/26-12/29: 安定稼働確認

Target: 2025-12-30 v1.3 完成 🎉
```

### マイルストーン

| 日付 | マイルストーン |
|------|--------------|
| 2025-12-09 | v1.2 完成（7日稼働確認完了） |
| 2025-12-12 | Phase 1 完了（Temporal Analytics） |
| 2025-12-18 | Phase 2 完了（Smart Suggestions） |
| 2025-12-22 | Phase 3 完了（Self-Improvement） |
| 2025-12-25 | Phase 4 完了（Integration） |
| 2025-12-30 | **v1.3 "Intelligence" 完成** 🎉 |

---

## 第8章：リスク管理

### 想定されるリスク

| リスク | 確率 | 影響 | 対策 |
|-------|------|------|------|
| **データ不足** | 中 | 高 | 過去30日分で十分かテスト |
| **LLM API コスト** | 中 | 中 | Claude Haiku 使用、キャッシュ活用 |
| **複雑化** | 高 | 中 | Phase ごとに切り分け、段階的導入 |
| **パフォーマンス低下** | 低 | 高 | 分析は非同期実行、キャッシュ活用 |

### 撤退条件

以下の場合、v1.3 を中断し v1.2.x の改善に戻る：

- Phase 1 が 7日以上遅延
- データ分析の精度が 60% 未満
- システム負荷が 2倍以上に増加
- ユーザー満足度が低下

---

## おわりに：知能の先にあるもの

v1.3 "Intelligence" は、Cortex OS が「記録する道具」から「**考えるパートナー**」へと進化する第一歩だ。

しかし、これは終わりではない。

**v1.4 では何が待っているのか？**

- Cortex OS が他のシステムと連携する？（Calendar, Email, GitHub）
- Cortex OS が複数人で共有される？（Team Mode）
- Cortex OS が自分でコードを書く？（Self-Modifying System）

**未来は、まだ決まっていない。**

---

**Version**: 1.3.0-draft  
**Author**: Cortex OS Team  
**Date**: 2025-12-05  
**Status**: Planning (Not Started)

---

## Appendix: 参考資料

### 関連ドキュメント

- [v1.2 "Autonomy" Roadmap](./v1.2-autonomy.md)
- [Cortex OS Requirements v1.3](../requirements/cortex-os.md)
- [Task Entry Schema](../requirements/task-entry-schema.md)
- [llms.txt Generation Pipeline](../requirements/llms-txt-generation.md)

### 技術参考

- [Obsidian Dataview API](https://blacksmithgu.github.io/obsidian-dataview/)
- [pandas Time Series Analysis](https://pandas.pydata.org/docs/user_guide/timeseries.html)
- [scikit-learn Regression](https://scikit-learn.org/stable/supervised_learning.html#regression)
- [Claude API Documentation](https://docs.anthropic.com/claude/reference)

---

**Next**: [Implementation Start](../../TODO.md) 🚀
