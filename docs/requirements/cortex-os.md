# Cortex OS Requirements v1.3

**Version**: 1.3  
**Date**: 2025-12-03  
**Status**: Production  
**Previous Version**: v1.2 "Autonomy" (2025-12-02)

---

## ğŸ“‹ Document Overview

This document specifies the requirements for Cortex OS v1.2 "Autonomy" - a self-operating personal knowledge and task management system.

### Change Summary (v1.1 â†’ v1.2)
- âœ… Automated KB rebuild (Recipe 02)
- âœ… Daily digest distribution (Recipe 09)
- âœ… TODO auto-sync (Recipe 10)
- âœ… Daily digest generation (Recipe 14)
- âœ… Nightly wrap-up (Recipe 13)
- âœ… Weekly summary (Recipe 11)

---

## ğŸ¯ Core Requirements

### R1: Autonomous Operation

**Requirement**: System MUST operate without daily human intervention for core loops.

**Acceptance Criteria**:
- Daily loop completes automatically (00:00, 03:00, 08:05, 22:00 JST)
- Weekly loop completes automatically
- Errors are logged and notified (Slack)
- System recovers from transient failures

**Implementation**:
- n8n scheduler with cron expressions
- Error handling: `onError: "continueErrorOutput"`
- Health monitoring via `/healthz` endpoints

---

### R2: Data Persistence

**Requirement**: All generated data MUST be persisted in version-controlled markdown.

**Acceptance Criteria**:
- Daily digests: `cortex/daily/YYYY-MM-DD-digest.md`
- Weekly summaries: `cortex/weekly/YYYY-WNN-summary.md`
- State files: `cortex/state/*.json`
- TODO management: `TODO.md` with date-stamped sections

**Implementation**:
- Obsidian REST API (PUT /vault/path)
- Git commits (automatic or manual)
- Atomic writes with error recovery

---

### R3: Knowledge Base Search

**Requirement**: System MUST provide semantic search across all markdown documents.

**Acceptance Criteria**:
- Search latency < 500ms (p95)
- Minimum 100 documents indexed
- Relevance: top-5 results include correct answer 80%+ of time
- Auto-rebuild: daily at 03:00 JST

**Implementation**:
- KB API service (port 4040)
- Hash-based embeddings (FNV-1a, 256 dimensions)
- Cosine similarity search
- Recipe 02 for automated rebuilds

---

### R4: Task Management

**Requirement**: System MUST synchronize tasks across multiple sources.

**Acceptance Criteria**:
- Today's Focus â†’ TODO.md sync (daily at 08:05 JST)
- Deduplication: identical tasks not duplicated
- Format consistency: `## Today â€” YYYY-MM-DD`
- Tag preservation: 5-tag system (#urgent, #deepwork, #blocked, #waiting, #review)

**Implementation**:
- Recipe 10 (TODO Auto-sync)
- Category prefixes: [Cortex], [n8n], etc.
- Emoji markers: âš¡ğŸš§â³ğŸ¯ğŸ‘ï¸
- HTML comments for tags: `<!-- #tag1,#tag2 -->`

---

## ğŸ”„ Autonomous Loops

### Daily Loop (Lifecycle-Aware Schedule)

**Target Days**: Monday, Wednesday, Friday, Saturday, Sunday (in-home days)
**Excluded**: Tuesday, Thursday (night shift days)

| Time | Recipe | Input | Output | Status | Cron |
|------|--------|-------|--------|--------|------|
| 20:00 JST | Recipe 13 | TODO.md | tomorrow.json | âœ… Active | `0 20 * * 0,1,3,5,6` |
| 20:10 JST | Recipe 14 | TODO.md, Git | Daily Digest | âœ… Active | `10 20 * * 0,1,3,5,6` |
| 20:30 JST | Recipe 02 | All .md files | KB Index | âœ… Active | `30 20 * * 0,1,3,5,6` |
| 20:40 JST | Recipe 10 | Today's Focus | TODO.md update | âœ… Active | `40 20 * * 0,1,3,5,6` |

**Rationale**: See [ADR-0011: Lifecycle-Aware Recipe Scheduling](../decisions/ADR-0011-lifecycle-aware-recipe-scheduling.md)

**Dependencies** (Evening Batch):
```
Recipe 13 (20:00) â†’ tomorrow.json
  â†“ (10 min)
Recipe 14 (20:10) â†’ Daily Digest (cortex/daily/YYYY-MM-DD-digest.md)
  â†“ (20 min)
Recipe 02 (20:30) â†’ KB Index (all .md files)
  â†“ (10 min)
Recipe 10 (20:40) â†’ TODO.md (synced for tomorrow)
  â†“
Next day: Human works on tasks (manual)
  â†“
Recipe 13 (20:00 next automation day) â†’ Cycle repeats
```

**Exception Days** (Tue/Thu):
- No automatic Recipe execution (night shift)
- Manual workflow: `/brief` on mobile or light note-taking
- Next automation: Following Mon/Wed/Fri evening

---

### Weekly Loop

| Frequency | Recipe | Input | Output | Status |
|-----------|--------|-------|--------|--------|
| Weekly | Recipe 11 | Daily Digests | Weekly Summary | âœ… Active |

---

## ğŸ“Š Data Formats

### TODO.md Structure

**Format Version**: 2.0 (2025-12-02)

```markdown
## Today â€” 2025-12-02

### High Priority
- [ ] [Cortex] âš¡ Critical task  <!-- #urgent,#deepwork -->
- [ ] [n8n] ğŸš§ Blocked task  <!-- #blocked -->

### Regular Tasks
- [ ] [Docs] ğŸ¯ Review task  <!-- #review -->

---

## Tomorrow â€” 2025-12-03
(Generated by Recipe 13)

## Backlog
...
```

**Breaking Changes from v1.0**:
- Section header: `## Today` â†’ `## Today â€” YYYY-MM-DD`
- Tags: inline â†’ HTML comments
- Categories: optional â†’ required prefix

---

### Daily Digest Template

**Format Version**: 1.0 (2025-11-30)

```markdown
# Daily Digest - YYYY-MM-DD

## Today's Focus
- [ ] Task 1
- [ ] Task 2

### High Priority
(Tasks with #urgent, #deepwork, #blocked, #waiting)

### Regular Tasks
(Other tagged tasks)

### No Tags
(Untagged tasks)

## Progress
(Manual entry)

## Reflection
(Manual entry)

---
**Generated**: ISO-8601 timestamp
**Source**: TODO.md (automatic extraction)
```

---

### KB Index Format

**Format Version**: 1.0 (2025-12-01)

```json
{
  "header": {
    "model": "text-embedding-3-small",
    "embed_mode": "hash",
    "embed_dim": 256,
    "created_at": "ISO-8601",
    "root": "/workspace/path",
    "files": 146,
    "chunks": 732
  },
  "data": [
    {
      "id": 0,
      "source": "relative/path.md",
      "chunk_index": 0,
      "text": "chunk content...",
      "embedding": [0.123, 0.456, ...]
    }
  ]
}
```

**Constraints**:
- `embed_dim`: MUST be 256 (hash mode) or 1536 (openai mode)
- `embedding`: MUST be L2-normalized (sum of squares = 1.0)
- `chunk_index`: MUST start from 0 for each file

---

## ğŸ—ï¸ System Architecture

### Service Topology

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Obsidian Vault (Port 27124)    â”‚
â”‚  - TODO.md                          â”‚
â”‚  - cortex/daily/YYYY-MM-DD-digest.mdâ”‚
â”‚  - cortex/state/tomorrow.json       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ REST API
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      n8n Automation (Port 5678)     â”‚
â”‚  - 13 Active Recipes                â”‚
â”‚  - Cron Scheduler                   â”‚
â”‚  - Error Handling                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KB API (Port     â”‚   â”‚  Slack Webhook    â”‚
â”‚  4040)            â”‚   â”‚  (Notifications)  â”‚
â”‚  - /search        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  - /reload        â”‚
â”‚  - /healthz       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Network Requirements

| Service | Port | Protocol | Access | TLS |
|---------|------|----------|--------|-----|
| Obsidian REST | 27124 | HTTPS | localhost | Self-signed |
| n8n | 5678 | HTTP | localhost | No |
| KB API | 4040 | HTTP | internal | No |

**Security**:
- Obsidian: Allow self-signed cert (`NODE_TLS_REJECT_UNAUTHORIZED=0` in n8n)
- KB API: Bearer token authentication (`KB_API_TOKEN`)
- n8n: Internal network only (Docker `internal-net`)

---

## ğŸ” Authentication

### Environment Variables

**Required**:
```bash
# Obsidian REST API
OBSIDIAN_API_KEY=<bearer-token>

# KB API
KB_API_TOKEN=<uuid>

# Slack Notifications
SLACK_DAILY_DIGEST_WEBHOOK=<webhook-url>
SLACK_WEEKLY_SUMMARY_WEBHOOK=<webhook-url>
```

**Optional**:
```bash
# Embedding mode
KB_EMBED_MODE=hash  # or 'openai' (requires OPENAI_API_KEY)
OPENAI_API_KEY=<api-key>  # only if KB_EMBED_MODE=openai
```

---

## ğŸ“ Recipe Specifications

### Recipe 02: KB Rebuild

**Schedule**: Daily at 03:00 JST  
**Duration**: ~30 seconds (146 files)  
**Status**: âœ… Production

**Input**:
- All `.md` files in workspace
- Excludes: `node_modules`, `.next`, `.git`

**Process**:
1. Find markdown files
2. Read content
3. Chunk (1200 chars, 200 overlap)
4. Generate embeddings (hash or openai)
5. Write `kb/index/embeddings.json`
6. POST `kb-api:4040/reload`

**Output**:
- `kb/index/embeddings.json` (updated)
- Slack notification (success/failure)

**Error Handling**:
- File read errors: Log warning, continue
- Embedding errors: Fail fast
- Reload errors: Report but don't fail

**SLA**:
- Availability: 99% (allowed to miss 1 day per 100 days)
- Latency: < 60 seconds for 200 files
- Accuracy: 100% (all files indexed)

---

### Recipe 10: TODO Auto-sync

**Schedule**: Daily at 08:05 JST  
**Duration**: < 5 seconds  
**Status**: âœ… Production

**Input**:
- `cortex/daily/YYYY-MM-DD-digest.md` (yesterday's digest, generated by Recipe 14)
- `TODO.md` (existing, via Obsidian REST API)

**Process**:
1. Read yesterday's digest from `cortex/daily/YYYY-MM-DD-digest.md`
2. Extract uncompleted tasks (`- [ ]`)
3. Parse category, emoji, tags
4. GET `TODO.md` via Obsidian REST API
5. Deduplicate (compare normalized text)
6. Build new section `## Today â€” YYYY-MM-DD`
7. Remove old `## Today â€”` section (regex)
8. PUT updated `TODO.md`

**Output**:
- `TODO.md` (updated)
- Slack notification (task count)

**Deduplication Logic**:
```javascript
function normalizeTask(line) {
  return line
    .replace(/^-\s*\[\s*\]\s*/, '')      // Remove checkbox
    .replace(/^\[.*?\]\s*/, '')           // Remove category
    .replace(/^[âš¡ğŸš§â³ğŸ¯ğŸ‘ï¸]\s*/, '')      // Remove emoji
    .replace(/\s*<!--.*?-->\s*$/, '')    // Remove tags
    .trim();
}
```

**Edge Cases**:
- Empty `Today's Focus`: Create section with placeholder
- Identical tasks: Skip (not duplicate)
- Malformed tasks: Log warning, skip

---

### Recipe 14: Daily Digest Generator

**Schedule**: Daily at 00:00 JST  
**Duration**: < 10 seconds  
**Status**: âœ… Production

**Input**:
- `TODO.md` (previous day)
- Git commits (previous day, JST timezone)
- Template: `cortex/templates/daily-digest-template.md`

**Process**:
1. Calculate target date (yesterday JST)
2. Read TODO.md
3. Extract `## Today â€” YYYY-MM-DD` section
4. Parse tasks by priority
5. Get git commits (JST date range)
6. Aggregate by type (feat/fix/docs/other)
7. Get git diffstat
8. Fill template
9. Write `cortex/daily/YYYY-MM-DD-digest.md`

**Output**:
- `cortex/daily/YYYY-MM-DD-digest.md`
- Slack notification (success)

**Git Integration**:
```bash
# Commit range (JST date)
git log --since="YYYY-MM-DD 00:00:00 +0900" \
        --until="YYYY-MM-DD 23:59:59 +0900" \
        --oneline
```

---

### Recipe 13: Nightly Wrap-up

**Schedule**: Daily at 22:00 JST  
**Duration**: < 5 seconds  
**Status**: âœ… Production

**Input**:
- `TODO.md`

**Process**:
1. Read TODO.md
2. Extract incomplete tasks
3. Generate tomorrow candidates (top 3-5)
4. Write `cortex/state/tomorrow.json`

**Output**:
```json
{
  "generated_at": "ISO-8601",
  "source_date": "YYYY-MM-DD",
  "tomorrow_candidates": [
    "Task 1",
    "Task 2",
    "Task 3"
  ]
}
```

---

### Recipe 11: Weekly Summary

**Schedule**: Weekly (Sunday)  
**Duration**: < 10 seconds  
**Status**: âœ… Production

**Input**:
- All `cortex/daily/*.md` for the week

**Process**:
1. Calculate week number (ISO 8601)
2. Find all digests for the week
3. Aggregate highlights
4. Aggregate completed tasks
5. Write `cortex/weekly/YYYY-WNN-summary.md`

**Output**:
- `cortex/weekly/YYYY-WNN-summary.md`

### Recipe 09: Daily Digest â†’ Claude Code (File + Slack)

**Schedule**: Daily at 08:00 JST
**Duration**: < 5 seconds
**Status**: âœ… Production

**Input**:
- `cortex/daily/YYYY-MM-DD-digest.md` (yesterday's digest from Obsidian)

**Process**:
1. Calculate yesterday's date (JST timezone)
2. GET digest from Obsidian via REST API (`https://host.docker.internal:27124/vault/`)
3. Extract tasks (multi-format support)
4. Extract Reflection section (with subsections)
5. Format Slack message
6. Write formatted digest to `notifications/daily/`
7. POST to Slack webhook

**Output**:
- Slack notification (formatted message with tasks + reflection)
- File: `/workspace/dauberside.github.io-1/notifications/daily/YYYY-MM-DD-digest.md`

**Task Extraction** (Enhanced 2025-12-03):
- **Checkbox format**: `- [ ] task` or `- [x] task`
- **Plain bullet format**: `- task` (excluding subsection headers)
- **Subsection support**: Extracts from `### High Priority`, `### Regular Tasks`, etc.
- **Section names**: Tries multiple: `Today's Focus`, `Tasks`, `High Priority`

**Reflection Extraction** (Enhanced 2025-12-03):
- Full section capture including subsections (`### å­¦ã³`, `### èª²é¡Œ`, `### æ°—ã¥ã`)
- Fixed boundary detection: Stops at `\n##`, `\n---`, or EOF
- Preserves multi-paragraph content and nested structure

**Dependencies**:
- **Service**: Obsidian REST API (port 27124)
- **Environment**: `OBSIDIAN_API_KEY`, `SLACK_DAILY_DIGEST_WEBHOOK`
- **Path**: Hardcoded `/workspace/dauberside.github.io-1/notifications/daily/` (n8n sandbox limitation)

**Error Handling**:
- Missing digest: Continue with "No tasks found" / "No reflection found"
- API errors: Log and continue (onError: continueRegularOutput)
- Empty sections: Report gracefully in Slack message

**Validation**:
- Output file exists: `/workspace/.../notifications/daily/YYYY-MM-DD-digest.md`
- Tasks extracted: `tasksFound` count >= 0
- Reflection extracted: `reflectionFound` boolean
- Slack delivery: HTTP 200 response

**Recent Updates** (2025-12-03):
- Fixed: Multi-format task extraction (checkbox + plain bullet + subsections)
- Fixed: Reflection extraction with proper regex boundaries
- Fixed: Removed `process.env.WORKSPACE_ROOT` (n8n sandbox incompatibility)
- Tested: 2025-12-01 (4 tasks + full reflection), 2025-12-02 (empty, graceful)

---

## ğŸ§® Embedding Algorithm

### Hash-based (Current)

**Algorithm**: FNV-1a (Fowler-Noll-Vo hash)  
**Dimensions**: 256  
**Normalization**: L2 (Euclidean)

**Process**:
```javascript
// 1. Tokenize
tokens = text.toLowerCase()
  .split(/[^a-z0-9]+/)
  .filter(Boolean);

// 2. Hash each token
vec = new Float32Array(256).fill(0);
for (token of tokens) {
  h = fnv1a(token);      // 32-bit hash
  idx = h % 256;
  vec[idx] += 1.0;
}

// 3. L2 Normalize
norm = sqrt(sum(vec^2));
vec = vec / norm;
```

**Pros**:
- Fast (no API calls)
- Deterministic (reproducible)
- Zero cost

**Cons**:
- No semantic understanding
- Lower precision than OpenAI

---

### OpenAI (Future)

**Model**: `text-embedding-3-small`  
**Dimensions**: 1536  
**API**: OpenAI Embeddings API

**Requirements**:
- `OPENAI_API_KEY` environment variable
- `KB_EMBED_MODE=openai`
- Rate limiting: 3000 RPM (tier 1)

**Cost Estimation**:
- 146 files Ã— 5 chunks/file = 730 chunks
- 730 chunks Ã— 300 tokens/chunk = 219,000 tokens
- Cost: $0.02 per 1M tokens = $0.0044 per rebuild
- Monthly: $0.13 (30 days)

---

## ğŸ¯ Performance Requirements

### Latency (p95)

| Operation | Target | Current | Status |
|-----------|--------|---------|--------|
| KB Search | < 500ms | ~200ms | âœ… |
| KB Rebuild | < 60s | ~30s | âœ… |
| TODO Sync | < 10s | ~3s | âœ… |
| Digest Gen | < 15s | ~8s | âœ… |

### Throughput

| Operation | Target | Current | Status |
|-----------|--------|---------|--------|
| KB Search | 10 qps | N/A | â³ |
| Chunks/sec | 100 | ~24 | âš ï¸ |

### Reliability

| Metric | Target | Current | Status |
|--------|--------|---------|--------|
| Uptime | 99% | ~95% | âš ï¸ |
| Error Rate | < 1% | ~0% | âœ… |
| Data Loss | 0 | 0 | âœ… |

**Note**: Uptime calculated over 30 days, excluding planned maintenance.

---

## ğŸ“Š Monitoring

### Health Checks

**KB API**:
```bash
curl http://localhost:4040/healthz
# Expected: {"ok": true}
```

**n8n**:
```bash
curl http://localhost:5678/healthz
# Expected: 200 OK
```

**Obsidian REST**:
```bash
curl -k https://localhost:27124/
# Expected: {"versions": ["1.5.3"], ...}
```

### Metrics

**KB API** (`/metrics`):
```json
{
  "uptimeSec": 43200,
  "totalRequests": 1523,
  "totalErrors": 2,
  "routes": {
    "/search": {"count": 1500, "errorCount": 0, "totalMs": 45000},
    "/reload": {"count": 20, "errorCount": 2, "totalMs": 500}
  }
}
```

### Alerts (Slack)

**Critical**:
- Recipe failure (any)
- KB API down
- Obsidian REST unreachable

**Warning**:
- Slow execution (> 2Ã— normal)
- High error rate (> 5%)

**Info**:
- Daily digest generated
- Weekly summary generated
- KB rebuild complete

---

## ğŸ”„ Upgrade Path

### v1.1 â†’ v1.2

**Breaking Changes**:
1. TODO format: `## Today` â†’ `## Today â€” YYYY-MM-DD`
2. Tags: inline â†’ HTML comments
3. KB Index: New format with header

**Migration Steps**:
1. Backup `TODO.md`
2. Update n8n workflows (Recipe 10, 14)
3. Run `scripts/kb-rebuild.mjs` manually
4. Verify Slack notifications
5. Monitor for 24 hours

**Rollback**:
- Revert n8n workflow JSON
- Restore `TODO.md` from backup
- Delete `kb/index/embeddings.json` (will rebuild with old format)

---

## ğŸ“ Future Requirements (v1.3+)

### v1.3: Intelligence

**Planned Features**:
- `/ask` command (KB + GPT)
- `/reflect` command (weekly analysis)
- Smart task prioritization

**Requirements**:
- OpenAI API integration
- Conversation history
- Context management (10K+ tokens)

### v1.4: Multi-agent

**Planned Features**:
- Parallel task execution
- Agent coordination
- Workflow composition

**Requirements**:
- Agent registry
- Message bus
- State synchronization

---

## ğŸ§ª Testing Requirements

### Unit Tests

**Coverage Target**: 80%  
**Framework**: Jest  
**Scope**: Core utilities

**Required**:
- Tokenization
- Hash functions
- Normalization
- Task parsing

### Integration Tests

**Scope**: Recipe end-to-end

**Required**:
- Recipe 02: KB rebuild â†’ verify embeddings.json
- Recipe 10: TODO sync â†’ verify format
- Recipe 14: Digest gen â†’ verify output

### Smoke Tests

**Frequency**: Before each deployment

**Checklist**:
- [ ] KB API `/healthz` returns 200
- [ ] n8n UI accessible
- [ ] Obsidian REST reachable
- [ ] Test recipe execution (manual trigger)
- [ ] Verify Slack notification

---

## ğŸ“– Related Documents

- [KB Requirements](./kb.md)
- [n8n Requirements](./n8n.md)
- [Task Management](./tasks.md)
- [Obsidian Integration](./obsidian.md)
- [Services](./services.md)

---

## ğŸ“ Changelog

### v1.2 (2025-12-02)
- Add Recipe 02 (KB Rebuild)
- Add Recipe 10 (TODO Auto-sync)
- Add Recipe 14 (Daily Digest)
- Update TODO format (v2.0)
- Add hash-based embeddings
- Add autonomous loop specifications

### v1.1 (2025-11-09)
- Initial version
- Basic requirements structure

---

**Review Status**: âœ… Approved  
**Next Review**: 2025-12-16 (2 weeks)  
**Maintainer**: Cortex OS Team
