# Recipe 03: Morning Brief with Slack Notification

**Version**: v1.2.1 (2025-12-03)  
**Status**: âš ï¸ Known Issue - Date Display  
**Category**: Daily Automation  
**Schedule**: 08:00 JST (Daily)

---

## Overview

Recipe 03 generates a personalized morning brief every day at 08:00 JST and sends it to Slack. It combines yesterday's digest with `tomorrow.json` (generated by Recipe 13 at 22:00) to create a focused task list with time estimates.

**Key Features**:
- ðŸ“Œ Top 3 tasks for today (from `tomorrow.json`)
- â± Time estimation with 20% buffer
- ðŸ”„ Carryover tasks from yesterday
- ðŸ’­ Yesterday's reflection summary
- ðŸ“± Slack DM notification

---

## Workflow Architecture

```
08:00 JST Cron Trigger
   â†“
Calculate Yesterday's Date
   â†“
Get Daily Note (digest) â”€â”€â”
   â†“                       â”‚
Get tomorrow.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â†“                       â”‚
Merge Sources â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
Build Morning Brief (with time estimates)
   â†“
Send to Slack (DM)
```

---

## Data Flow

### Input Sources

1. **yesterday's digest** (`cortex/daily/YYYY-MM-DD-digest.md`)
   - Tasks from yesterday
   - Reflection notes
   
2. **tomorrow.json** (`cortex/state/tomorrow.json`)
   - Generated by Recipe 13 at 22:00
   - Contains:
     - `tomorrow_candidates`: Top 3 tasks for today
     - `carryover_tasks`: Unfinished tasks from yesterday
     - `reflection_summary`: Key insights from yesterday

### Output

**Slack Message Format**:
```
â˜€ï¸ *Morning Brief â€” 2025-12-03*

ðŸ“Œ *Today's Focus (Top 3)*
1. v1.2 Roadmap ç¢ºèª (1h)
2. Recipe 10 ä¿®æ­£å®Œäº†ç¢ºèª âš¡ (1.5h)
3. Knowledge Graph ã‚¿ã‚¹ã‚¯è©•ä¾¡ ðŸŽ¯ (2h)

â± *Time Budget*: 4.5h + 1h buffer = 5.5h

ðŸ”„ *Carryover from Yesterday*
- Recipe 02/14 ãƒ­ã‚°ç¢ºèª
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´ç†

ðŸ’­ *Yesterday's Reflection*
Recipe 10 ã®5ã‚¿ã‚°ã‚·ã‚¹ãƒ†ãƒ ãŒäºˆæƒ³ä»¥ä¸Šã«ã†ã¾ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã€‚
```

---

## Time Estimation Logic

Recipe 03 uses a simple heuristic for time estimates:

| Tag/Emoji | Estimated Time | Reason |
|-----------|----------------|--------|
| `#urgent` / âš¡ | 1.5h | Time-critical, requires immediate focus |
| `#deepwork` / ðŸŽ¯ | 2h | Deep concentration required |
| Regular (no tag) | 1h | Standard task |

**Buffer Calculation**: 20% of total estimated time (rounded up)

**Example**:
- Task 1: 1h
- Task 2 (âš¡): 1.5h
- Task 3 (ðŸŽ¯): 2h
- Total: 4.5h
- Buffer: 1h (20% of 4.5h)
- **Final Budget**: 5.5h

---

## Configuration

### Environment Variables

```bash
# .env or n8n environment
OBSIDIAN_API_KEY=your_obsidian_api_key_here
SLACK_DAILY_DIGEST_WEBHOOK=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

### Obsidian REST API

- **Host**: `host.docker.internal:27124` (Docker) or `127.0.0.1:27124` (Local)
- **Protocol**: HTTPS
- **Auth**: Bearer token (`OBSIDIAN_API_KEY`)
- **Endpoints**:
  - `GET /vault/cortex/daily/{date}-digest.md`
  - `GET /vault/cortex/state/tomorrow.json`

---

## Integration with Recipe 13

Recipe 03 depends on **Recipe 13 (Nightly Wrap-up)** for `tomorrow.json`:

| Time | Recipe | Action | Output |
|------|--------|--------|--------|
| 22:00 | Recipe 13 | Read today's digest + TODO.md | `tomorrow.json` |
| 08:00 | Recipe 03 | Read `tomorrow.json` + yesterday's digest | Slack Morning Brief |

**Data Bridge**: `cortex/state/tomorrow.json`

---

## Error Handling

### Common Issues

**1. tomorrow.json not found**
```
Error: GET /vault/cortex/state/tomorrow.json â†’ 404
```
**Solution**: 
- Verify Recipe 13 ran successfully at 22:00
- Check Obsidian REST API is running
- Manually trigger Recipe 13 to generate `tomorrow.json`

---

**2. Empty task list**
```
Message: "ï¼ˆã‚¿ã‚¹ã‚¯ãªã— - tomorrow.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰"
```
**Solution**:
- Check `tomorrow.json` has non-empty `tomorrow_candidates`
- Verify Recipe 13's task extraction logic
- Check TODO.md has tasks for tomorrow

---

**3. Slack notification fails**
```
Error: POST to Slack webhook â†’ 404/403
```
**Solution**:
- Verify `SLACK_DAILY_DIGEST_WEBHOOK` is correct
- Check webhook is not expired
- Test webhook with `curl`:
  ```bash
  curl -X POST $SLACK_DAILY_DIGEST_WEBHOOK \
    -H "Content-Type: application/json" \
    -d '{"text":"Test from Recipe 03"}'
  ```

---

## Monitoring

### Daily Check (30 seconds)

```bash
# Check Recipe 03 last execution
curl http://localhost:5678/api/v1/executions?workflowId=recipe-03 | jq '.data[0]'

# Check Slack webhook
curl -X POST $SLACK_DAILY_DIGEST_WEBHOOK \
  -H "Content-Type: application/json" \
  -d '{"text":"âœ… Recipe 03 monitoring test"}'
```

### Weekly Review (5 minutes)

- Open n8n UI: http://localhost:5678
- Navigate to: Workflows â†’ Recipe 03
- Check: Executions (last 7 days)
- Success rate target: **> 95%**

---

## Testing

### Manual Test

1. **Prepare test data**:
   ```bash
   # Create test tomorrow.json
   cat > /path/to/obsidian/cortex/state/tomorrow.json <<EOF
   {
     "generated_at": "2025-12-03T13:00:00.000Z",
     "source_date": "2025-12-03",
     "tomorrow_candidates": [
       "Test task 1",
       "Test task 2 #urgent",
       "Test task 3 #deepwork"
     ],
     "carryover_tasks": ["Carryover test"],
     "reflection_summary": "Test reflection"
   }
   EOF
   ```

2. **Trigger Recipe 03 manually** (n8n UI):
   - Open Recipe 03 workflow
   - Click "Execute Workflow"
   - Check Slack for test message

3. **Verify output**:
   - âœ… Slack message received
   - âœ… Top 3 tasks listed
   - âœ… Time estimates correct
   - âœ… Buffer calculated (20%)

---

## Known Issues

### Date Display Bug (v1.2)

**Issue**: Slack message shows yesterday's date instead of today's date.

**Example**:
```
âŒ Current: "Morning Brief â€” 2025-12-02" (when running on 2025-12-03)
âœ… Expected: "Morning Brief â€” 2025-12-03"
```

**Root Cause**: 
The "Build Morning Brief" node extracts date from yesterday's digest file header instead of using today's date.

**Workaround**: 
Tasks and data are correct; only the date label is off by one day.

**Fix** (n8n UI):
1. Open Recipe 03 workflow
2. Edit "Build Morning Brief" node
3. Replace date extraction logic:
   ```javascript
   // OLD (extracts from digest header)
   let date = 'unknown';
   const headerMatch = content.match(/^#\s*Daily Digest[\sâ€”-]+([\d-]+)/m);
   if (headerMatch) date = headerMatch[1];
   
   // NEW (use today's date)
   const now = new Date();
   const year = now.getFullYear();
   const month = String(now.getMonth() + 1).padStart(2, '0');
   const day = String(now.getDate()).padStart(2, '0');
   const date = `${year}-${month}-${day}`;
   ```

**Priority**: Low (cosmetic issue, does not affect functionality)

---

## Changelog

### v1.2.1 (2025-12-03) - Documentation Update
- âš ï¸ Documented date display bug
- ðŸ“ Added fix instructions for n8n UI

### v1.2 (2025-12-03) - Slack Integration & Time Estimates
- âœ… Added `tomorrow.json` integration (Recipe 13 data bridge)
- âœ… Time estimation with tag-based heuristics
- âœ… 20% buffer calculation
- âœ… Carryover tasks display
- âœ… Yesterday's reflection summary
- âœ… Slack DM notification

### v1.0 (2025-11-18) - Initial Release
- Basic digest parsing
- Task extraction
- Reflection extraction

---

## Related Documentation

- **Recipe 13 (Nightly Wrap-up)**: [recipe-13-nightly-wrapup.md](./recipe-13-nightly-wrapup.md)
- **Recipe 10 (TODO Auto-sync)**: [recipe-10-tags.md](./recipe-10-tags.md)
- **Cortex OS v1.2 Roadmap**: [../cortex/v1.2-autonomy.md](../cortex/v1.2-autonomy.md)
- **Recipe Monitoring**: [../operations/recipe-monitoring.md](../operations/recipe-monitoring.md)

---

**Author**: Cortex OS Development Team  
**Last Updated**: 2025-12-03  
**Status**: Living Document
