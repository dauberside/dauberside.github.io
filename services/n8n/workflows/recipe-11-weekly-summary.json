{
  "name": "Recipe 11: Weekly Summary (Cortex OS)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtDay": [0],
              "triggerAtHour": 23,
              "triggerAtMinute": 0
            }
          ]
        }
      },
      "id": "weekly-trigger",
      "name": "Weekly Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "// ç›´è¿‘7æ—¥åˆ†ã®æ—¥ä»˜ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ\nconst dates = [];\nconst now = new Date();\n\nfor (let i = 1; i <= 7; i++) {\n  const d = new Date(now);\n  d.setDate(d.getDate() - i);\n  const y = d.getFullYear();\n  const m = String(d.getMonth() + 1).padStart(2, '0');\n  const day = String(d.getDate()).padStart(2, '0');\n  const dateStr = `${y}-${m}-${day}`;\n  \n  dates.push({\n    date: dateStr,\n    filepath: `cortex/daily/${dateStr}-digest.md`\n  });\n}\n\nreturn dates.map(d => ({ json: d }));"
      },
      "id": "generate-dates",
      "name": "Generate Date List",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "command": "=cat /workspace/dauberside.github.io-1/{{ $json.filepath }} 2>/dev/null || echo ''"
      },
      "id": "fetch-digest",
      "name": "Fetch Digest from Obsidian",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [680, 300],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "allDigests",
        "include": "allFieldsExceptBinary"
      },
      "id": "aggregate-digests",
      "name": "Aggregate Digests",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.first().json.allDigests || [];\n\n// æœ‰åŠ¹ãªãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã®ã¿æŠ½å‡º\nconst digests = items\n  .filter(item => {\n    const text = item.stdout || item.data || '';\n    return text && typeof text === 'string' && text.length > 0;\n  })\n  .map(item => ({\n    date: item.date,\n    text: item.stdout || item.data || ''\n  }));\n\n// ã‚¿ã‚¹ã‚¯ & Reflection æŠ½å‡º\nlet completed = 0;\nlet pending = 0;\nconst highlights = [];\nconst reflections = [];\nconst challenges = [];\n\nfor (const d of digests) {\n  const lines = d.text.split('\\n');\n\n  for (const line of lines) {\n    const trimmed = line.trim();\n\n    // ã‚¿ã‚¹ã‚¯\n    if (trimmed.startsWith('- [x]')) completed++;\n    if (trimmed.startsWith('- [ ]')) pending++;\n\n    // Challenges\n    if (trimmed.toLowerCase().includes('blocked') || trimmed.includes('è©°ã¾ã£ãŸ') || trimmed.includes('èª²é¡Œ')) {\n      challenges.push(`- ${d.date}: ${trimmed}`);\n    }\n  }\n\n  // Reflection ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ½å‡º\n  if (d.text.includes('## Reflection')) {\n    const reflectionSection = d.text.split('## Reflection')[1];\n    if (reflectionSection) {\n      const reflectionLines = reflectionSection.split('\\n').filter(l => l.trim().startsWith('- '));\n      reflectionLines.forEach(rl => {\n        if (!reflections.includes(rl.trim())) {\n          reflections.push(rl.trim());\n        }\n      });\n    }\n  }\n\n  // ãƒã‚¤ãƒ©ã‚¤ãƒˆå€™è£œ\n  if (d.text.includes('ğŸ†') || d.text.toLowerCase().includes('highlight')) {\n    highlights.push(`- ${d.date}: ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™`);\n  }\n}\n\nconst total = completed + pending;\nconst rate = total === 0 ? 0 : Math.round((completed / total) * 100);\n\n// é€±ã®ç¯„å›²\nconst weekStart = digests.length > 0 ? digests[digests.length - 1].date : null;\nconst weekEnd = digests.length > 0 ? digests[0].date : null;\nconst weekLabel = weekStart && weekEnd ? `${weekStart} ã€œ ${weekEnd}` : 'ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';\nconst year = weekEnd ? weekEnd.slice(0, 4) : new Date().getFullYear();\n\n// é€±ç•ªå·\nconst endDate = weekEnd ? new Date(weekEnd) : new Date();\nconst onejan = new Date(endDate.getFullYear(), 0, 1);\nconst week = Math.ceil((((endDate - onejan) / 86400000) + onejan.getDay() + 1) / 7);\nconst weekId = `${year}-W${String(week).padStart(2, '0')}`;\n\n// Markdown æœ¬æ–‡\nconst md = [\n  `# Weekly Summary â€” ${weekId}`,\n  '',\n  `å¯¾è±¡æœŸé–“: ${weekLabel}`,\n  `å–å¾—ã§ããŸæ—¥æ•°: ${digests.length}/7`,\n  '',\n  '## ğŸ“Š Overview',\n  `- å®Œäº†ã‚¿ã‚¹ã‚¯æ•°: ${completed}`,\n  `- æœªå®Œäº†ã‚¿ã‚¹ã‚¯æ•°: ${pending}`,\n  `- é€²æ—ç‡: ${rate}%`,\n  '',\n  '## ğŸ† Highlights',\n  highlights.length ? highlights.join('\\n') : '- ï¼ˆç‰¹ã«æ˜ç¤ºã•ã‚ŒãŸãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰',\n  '',\n  '## ğŸ§  Reflection',\n  reflections.length ? reflections.slice(0, 5).join('\\n') : '- ï¼ˆReflection ã®è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰',\n  '',\n  '## âš ï¸ Challenges',\n  challenges.length ? challenges.join('\\n') : '- ï¼ˆç‰¹ã«è¨˜éŒ²ã•ã‚ŒãŸèª²é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰',\n  '',\n  '## ğŸ¯ Next Week Focus',\n  '- ä»Šé€±ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‹ã‚‰ 1ã€œ3 ä»¶ã‚’é¸ã³ã€/brief ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã‚‹',\n  '- Recipe / Cortex OS ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ 1 ã¤ã ã‘æ”¹å–„ã™ã‚‹',\n  '- 1ã¤ã€Œã‚„ã‚‰ãªã„ã“ã¨ã€ã‚’æ±ºã‚ã‚‹',\n  '',\n].join('\\n');\n\nreturn [\n  {\n    json: {\n      weekId,\n      weekLabel,\n      digestCount: digests.length,\n      markdown: md,\n      overview: {\n        completed,\n        pending,\n        rate,\n      },\n    },\n  },\n];"
      },
      "id": "build-summary",
      "name": "Build Weekly Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "command": "=mkdir -p /workspace/dauberside.github.io-1/cortex/weekly && cat > /workspace/dauberside.github.io-1/cortex/weekly/{{ $json.weekId }}-summary.md << 'EOFMARKER'\n{{ $json.markdown }}\nEOFMARKER"
      },
      "id": "write-obsidian",
      "name": "Write Weekly to Obsidian",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1340, 200],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SLACK_WEEKLY_SUMMARY_WEBHOOK }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"text\": \"ğŸ“† *Cortex OS Weekly Summary â€” {{ $json.weekId }}*\\n\\nâ€¢ æœŸé–“: {{ $json.weekLabel }}\\nâ€¢ å–å¾—æ—¥æ•°: {{ $json.digestCount }}/7\\nâ€¢ å®Œäº†ã‚¿ã‚¹ã‚¯: {{ $json.overview.completed }}\\nâ€¢ æœªå®Œäº†ã‚¿ã‚¹ã‚¯: {{ $json.overview.pending }}\\nâ€¢ é€²æ—ç‡: {{ $json.overview.rate }}%\\n\\nè©³ã—ãã¯: Obsidian ã® `weekly/{{ $json.weekId }}-summary.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚\"\n}",
        "options": {}
      },
      "id": "slack-notify",
      "name": "Post Weekly Summary to Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 400],
      "onError": "continueRegularOutput"
    }
  ],
  "connections": {
    "Weekly Trigger": {
      "main": [
        [
          {
            "node": "Generate Date List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Date List": {
      "main": [
        [
          {
            "node": "Fetch Digest from Obsidian",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Digest from Obsidian": {
      "main": [
        [
          {
            "node": "Aggregate Digests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Digests": {
      "main": [
        [
          {
            "node": "Build Weekly Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Weekly Summary": {
      "main": [
        [
          {
            "node": "Write Weekly to Obsidian",
            "type": "main",
            "index": 0
          },
          {
            "node": "Post Weekly Summary to Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "cortex-os"
    },
    {
      "name": "weekly"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-11-18T00:00:00.000Z",
  "versionId": "2"
}
