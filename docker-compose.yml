version: "3.9"

services:
  kb-api:
    build:
      context: ./services/kb-api
      dockerfile: Dockerfile
    container_name: kb-api
    environment:
      - NODE_ENV=production
      - PORT=4040
      - KB_API_PORT=4040
      # Mounts ./kb -> /app/kb; default relative resolve also works, but we pin the path
      - KB_INDEX_PATH=/app/kb/index/embeddings.json
      - KB_EMBED_MODE=${KB_EMBED_MODE:-hash}
      - KB_EMBED_DIM=${KB_EMBED_DIM:-256}
      - KB_API_MOCK=${KB_API_MOCK:-0}
      - KB_API_TOKEN=${KB_API_TOKEN:-}
      - KB_API_BASIC=${KB_API_BASIC:-0}
      - ADMIN_BASIC_USERS=${ADMIN_BASIC_USERS:-}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-}
    volumes:
      - ./kb:/app/kb:ro
    expose:
      - "4040"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4040/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  n8n:
    image: n8nio/n8n:1.116.2
    container_name: n8n
    environment:
      - TZ=Asia/Tokyo
      - GENERIC_TIMEZONE=Asia/Tokyo
      - N8N_SECURE_COOKIE=false
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - WEBHOOK_URL=http://localhost:5678/
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false
      - N8N_METRICS=true
      - N8N_RUNNERS_ENABLED=true
      - DB_SQLITE_POOL_SIZE=5
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-0}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-}
      # Google Calendar credentials for workflows
      - GC_CLIENT_ID=${GC_CLIENT_ID:-}
      - GC_CLIENT_SECRET=${GC_CLIENT_SECRET:-}
      - GC_REFRESH_TOKEN=${GC_REFRESH_TOKEN:-}
      - GC_REDIRECT_URI=${GC_REDIRECT_URI:-}
      - CALENDAR_ID=${CALENDAR_ID:-primary}
      # Obsidian & Slack for Recipe 09: Daily Digest
      - OBSIDIAN_API_KEY=${OBSIDIAN_API_KEY:-}
      - SLACK_DAILY_DIGEST_WEBHOOK=${SLACK_DAILY_DIGEST_WEBHOOK:-}
      # Slack for Recipe 11: Weekly Summary
      - SLACK_WEEKLY_SUMMARY_WEBHOOK=${SLACK_WEEKLY_SUMMARY_WEBHOOK:-}
      # Workspace root for scripts
      - WORKSPACE_ROOT=/workspace/dauberside.github.io-1
    ports:
      - "5678:5678"
    # ... 既存設定 ...
    volumes:
      # リポジトリ全体をマウント（cortex は symlink 経由で Obsidian から参照）
      - "/Volumes/Extreme Pro/dauberside.github.io-1:/workspace/dauberside.github.io-1"
      - n8n_data:/home/node/.n8n
      - ./data/chat-logs:/data/chat-logs
      
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5678/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

networks:
  default:
    name: internal-net

volumes:
  n8n_data:
