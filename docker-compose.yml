# Docker Compose 簡素版（プラン A: 最小構成）
# KB API と MCP HTTP サーバーを削除し、n8n のみを保持
# KB 検索と Obsidian 操作は Next.js API (/api/kb/*, /api/obsidian/*) 経由で実行

services:
  n8n:
    image: n8nio/n8n:1.116.2
    container_name: n8n
    environment:
      - TZ=Asia/Tokyo
      - GENERIC_TIMEZONE=Asia/Tokyo
      - N8N_SECURE_COOKIE=false
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - WEBHOOK_URL=http://localhost:5678/
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false
      - N8N_METRICS=true
      - N8N_RUNNERS_ENABLED=true
      - DB_SQLITE_POOL_SIZE=5
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-0}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-}
      # Next.js API endpoints (n8n から直接アクセス)
      - NEXT_API_URL=http://host.docker.internal:3001
      - INTERNAL_API_TOKEN=${INTERNAL_API_TOKEN:-}
      # Google Calendar credentials for workflows
      - GC_CLIENT_ID=${GC_CLIENT_ID:-}
      - GC_CLIENT_SECRET=${GC_CLIENT_SECRET:-}
      - GC_REFRESH_TOKEN=${GC_REFRESH_TOKEN:-}
      - GC_REDIRECT_URI=${GC_REDIRECT_URI:-}
      - CALENDAR_ID=${CALENDAR_ID:-primary}
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./data/chat-logs:/data/chat-logs    # NDJSONを永続化
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5678/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

networks:
  default:
    name: internal-net

volumes:
  n8n_data:
