# v1.3 Entry Gate å®Ÿè£…ã‚¬ã‚¤ãƒ‰ï¼ˆæœ€å°å·¥æ•°ç‰ˆï¼‰

**ç›®çš„**: 2025-12-15ã®Entry Gateé€šéã«å¿…è¦ãªæœ€å°å®Ÿè£…ã‚’å®Œäº†ã•ã›ã‚‹
**æ‰€è¦æ™‚é–“**: 3-4æ™‚é–“ï¼ˆåœŸæ—¥ã§å®Œäº†å¯èƒ½ï¼‰
**å‰æ**: v1.2é‹ç”¨æ”¹å–„å®Œäº†ã€Recipe 10æ­£å¸¸å‹•ä½œç¢ºèªæ¸ˆã¿

---

## ğŸ¯ å®Ÿè£…ã™ã‚‹2ã¤ã®åŸºç›¤

### A) LoggingåŸºç›¤ï¼ˆJSONLï¼‰- 2æ™‚é–“
### B) Categoryæ¨å®šï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ï¼‰- 2æ™‚é–“

---

## A) LoggingåŸºç›¤å®Ÿè£…ï¼ˆJSONLå½¢å¼ï¼‰

### 1. JSONLæ¨™æº–å½¢ï¼ˆãã®ã¾ã¾æ¡ç”¨ï¼‰

```json
{
  "ts": "2025-12-14T23:05:31.120Z",
  "workflow": "Recipe 10: TODO.md Auto-sync",
  "executionId": "abc123",
  "status": "success",
  "durationMs": 1842,
  "env": "production",
  "errorMessage": null,
  "meta": {
    "tasksAdded": 7,
    "statusCode": 204,
    "target": "vault/TODO.md"
  }
}
```

**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èª¬æ˜**:
- `ts`: ISO 8601å½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
- `workflow`: Recipeåï¼ˆè­˜åˆ¥ç”¨ï¼‰
- `executionId`: n8nå®Ÿè¡ŒID
- `status`: `success` or `error`
- `durationMs`: å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
- `env`: `production`, `staging`, `local`
- `errorMessage`: ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿ã€æˆåŠŸæ™‚ã¯ `null`
- `meta`: Recipeå›ºæœ‰ã®è¦³æ¸¬å€¤ï¼ˆè‡ªç”±æ ï¼‰

---

### 2. ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

```
cortex/logs/recipe-10-2025-12-14.jsonl
cortex/logs/recipe-02-2025-12-14.jsonl
cortex/logs/recipe-03-2025-12-14.jsonl
```

**ç‰¹å¾´**:
- 1æ—¥1ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ—¥æ¬¡ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥ä»˜ã¨Recipeç•ªå·ãŒè­˜åˆ¥å¯èƒ½
- `.jsonl` æ‹¡å¼µå­ï¼ˆ1è¡Œ1JSONï¼‰

---

### 3. n8nå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ¨å¥¨ï¼šLog Collectoræ–¹å¼ï¼‰

#### Method A: Log Collector Workflowï¼ˆæ¨å¥¨ï¼‰

**æ–°è¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ**: `Log Collector`

**æ§‹æˆ**:
```
Webhook Trigger (/log)
    â†“
Validate JSON
    â†“
Format Log Entry
    â†“
Append to File (or Execute Command)
```

**Webhookè¨­å®š**:
- Path: `/log`
- Method: POST
- Authentication: ãªã—ï¼ˆå†…éƒ¨å°‚ç”¨ï¼‰

**Append to File Nodeï¼ˆExecute Commandä½¿ç”¨ï¼‰**:
```javascript
// Code Node: Format filename
const ts = new Date($json.ts);
const date = ts.toISOString().split('T')[0]; // YYYY-MM-DD
const workflowMatch = $json.workflow.match(/Recipe (\d+)/);
const recipeNum = workflowMatch ? workflowMatch[1].padStart(2, '0') : '99';

const filename = `cortex/logs/recipe-${recipeNum}-${date}.jsonl`;
const logLine = JSON.stringify($json);

return {
  json: {
    filename,
    logLine,
    command: `echo '${logLine}' >> /workspace/dauberside.github.io-1/${filename}`
  }
};
```

**Execute Command Node**:
```bash
{{ $json.command }}
```

**å„Recipeã‹ã‚‰ã®HTTP Request**ï¼ˆä¾‹: Recipe 10ã®æœ€å¾Œã«è¿½åŠ ï¼‰:
```javascript
// Code Node: Prepare Log Entry
const startTime = $('Daily 08:05 JST (TODO Sync)').first().json.startTime || Date.now();
const endTime = Date.now();

const logEntry = {
  ts: new Date().toISOString(),
  workflow: "Recipe 10: TODO.md Auto-sync",
  executionId: $executionId,
  status: "success",
  durationMs: endTime - startTime,
  env: "production",
  errorMessage: null,
  meta: {
    tasksAdded: $('Verify TODO Sync').first().json.tasksAdded || 0,
    statusCode: $('Update TODO.md').first().json.statusCode || 200,
    target: "vault/TODO.md"
  }
};

return { json: logEntry };
```

**HTTP Request Node**:
- Method: POST
- URL: `http://localhost:5678/webhook/log`
- Body: `{{ $json }}`

**ãƒ¡ãƒªãƒƒãƒˆ**:
- å„Recipeã¯ã€Œé€ã‚‹ã ã‘ã€ï¼ˆæ›¸ãè¾¼ã¿æ¨©é™ä¸è¦ï¼‰
- ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆçµ±ä¸€ãŒå®¹æ˜“
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ä¸€ç®‡æ‰€ã«é›†ç´„

---

#### Method B: å„Recipeã§ç›´æ¥è¿½è¨˜ï¼ˆç°¡æ˜“ç‰ˆï¼‰

**Execute Command Node**ï¼ˆå„Recipeã®æœ€å¾Œã«è¿½åŠ ï¼‰:
```bash
echo '{"ts":"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)","workflow":"Recipe 10","executionId":"$executionId","status":"success","durationMs":1842,"env":"production","errorMessage":null,"meta":{}}' >> cortex/logs/recipe-10-$(date +%Y-%m-%d).jsonl
```

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- å„Recipeã«ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æ¨©é™ãŒå¿…è¦
- JSONç”ŸæˆãŒå„æ‰€ã«æ•£åœ¨

**æ¨å¥¨**: Method Aã‚’å„ªå…ˆã€ç’°å¢ƒåˆ¶ç´„ãŒã‚ã‚‹å ´åˆã®ã¿Method B

---

### 4. Entry Gateæ¡ä»¶ï¼ˆObservabilityï¼‰

**ãƒã‚§ãƒƒã‚¯æ–¹æ³•**:
```bash
# 7æ—¥åˆ†ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
ls -lh cortex/logs/recipe-*-$(date -d '7 days ago' +%Y-%m-%d).jsonl

# analyze-health.pyãŒå‹•ä½œã™ã‚‹ã‹ç¢ºèª
python3 scripts/analyze-health.py --window-days 7
```

**æœŸå¾…çµæœ**:
- `no_data` ã«ãªã‚‰ãªã„
- Automation scoreãŒ50 â†’ 75ä»¥ä¸Šã«ä¸ŠãŒã‚‹

---

## B) Categoryæ¨å®šå®Ÿè£…ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ï¼‰

### 1. ã‚«ãƒ†ã‚´ãƒªå®šç¾©ï¼ˆ5ç¨®+generalï¼‰

| Category | Keywords |
|----------|----------|
| `dev` | fix, bug, implement, refactor, PR, ãƒ¬ãƒ“ãƒ¥ãƒ¼, CI, ãƒ†ã‚¹ãƒˆ, ã‚³ãƒ¼ãƒ‰, å®Ÿè£… |
| `doc` | doc, docs, README, è¨­è¨ˆ, ä»•æ§˜, ãƒ¡ãƒ¢, ã¾ã¨ã‚, ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| `ops` | deploy, release, n8n, docker, cron, éšœå®³, å¾©æ—§, ãƒ­ã‚°, ç›£è¦–, Recipe |
| `research` | èª¿æŸ», æ¤œè¨¼, PoC, æ¯”è¼ƒ, è©¦ã™, èª­ã‚€, è«–æ–‡, ã‚µãƒ¼ãƒ™ã‚¤ |
| `meeting` | mtg, meeting, 1on1, è­°äº‹éŒ², sync, æ‰“ã¡åˆã‚ã›, ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| `general` | ï¼ˆåˆ¤å®šä¸èƒ½æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ |

---

### 2. ã‚«ãƒ†ã‚´ãƒªæ¨å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆJavaScriptï¼‰

```javascript
// Category Estimation Function
function estimateCategory(taskTitle) {
  const title = taskTitle.toLowerCase();

  // ã‚«ãƒ†ã‚´ãƒªå®šç¾©ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â†’ ã‚¹ã‚³ã‚¢ï¼‰
  const categories = {
    dev: ['fix', 'bug', 'implement', 'refactor', 'pr', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼', 'ci', 'ãƒ†ã‚¹ãƒˆ', 'ã‚³ãƒ¼ãƒ‰', 'å®Ÿè£…'],
    doc: ['doc', 'readme', 'è¨­è¨ˆ', 'ä»•æ§˜', 'ãƒ¡ãƒ¢', 'ã¾ã¨ã‚', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ'],
    ops: ['deploy', 'release', 'n8n', 'docker', 'cron', 'éšœå®³', 'å¾©æ—§', 'ãƒ­ã‚°', 'ç›£è¦–', 'recipe'],
    research: ['èª¿æŸ»', 'æ¤œè¨¼', 'poc', 'æ¯”è¼ƒ', 'è©¦ã™', 'èª­ã‚€', 'è«–æ–‡', 'ã‚µãƒ¼ãƒ™ã‚¤'],
    meeting: ['mtg', 'meeting', '1on1', 'è­°äº‹éŒ²', 'sync', 'æ‰“ã¡åˆã‚ã›', 'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°']
  };

  // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
  const scores = {};
  let totalScore = 0;
  let matchedKeywords = [];

  for (const [category, keywords] of Object.entries(categories)) {
    scores[category] = 0;
    for (const keyword of keywords) {
      if (title.includes(keyword)) {
        scores[category] += 1;
        matchedKeywords.push(keyword);
      }
    }
    totalScore += scores[category];
  }

  // æœ€é«˜ã‚¹ã‚³ã‚¢ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ
  if (totalScore === 0) {
    return {
      category: 'general',
      categoryConfidence: 1.0,
      categoryReason: 'no_keywords_matched'
    };
  }

  const bestCategory = Object.keys(scores).reduce((a, b) =>
    scores[a] > scores[b] ? a : b
  );

  const confidence = scores[bestCategory] / totalScore;

  return {
    category: bestCategory,
    categoryConfidence: parseFloat(confidence.toFixed(2)),
    categoryReason: matchedKeywords.slice(0, 3).join(',') // æœ€å¤§3å€‹
  };
}

// ä½¿ç”¨ä¾‹
const tasks = $input.all();
const enrichedTasks = tasks.map(task => {
  const estimation = estimateCategory(task.json.title);
  return {
    json: {
      ...task.json,
      ...estimation
    }
  };
});

return enrichedTasks;
```

---

### 3. Recipe 14ã¸ã®çµ„ã¿è¾¼ã¿

**é…ç½®å ´æ‰€**: Recipe 14ï¼ˆDaily Digest Generatorï¼‰ã®ã€Œã‚¿ã‚¹ã‚¯æŠ½å‡ºã€ã®å¾Œ

**ãƒãƒ¼ãƒ‰æ§‹æˆ**:
```
Extract Tasks
    â†“
Estimate Category (Code Node)  â† ä¸Šè¨˜ã®JSé–¢æ•°ã‚’é…ç½®
    â†“
Save to category_heatmap.json
```

**category_heatmap.json æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯**:
```javascript
// Code Node: Update Category Heatmap
const tasks = $input.all();
const date = new Date().toISOString().split('T')[0];

// ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ
const heatmap = {};
tasks.forEach(task => {
  const category = task.json.category || 'general';
  heatmap[category] = (heatmap[category] || 0) + 1;
});

// æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚ã‚Œã°ï¼‰
const fs = require('fs');
const heatmapPath = '/workspace/dauberside.github.io-1/cortex/state/category_heatmap.json';

let existing = { entries: [] };
if (fs.existsSync(heatmapPath)) {
  existing = JSON.parse(fs.readFileSync(heatmapPath, 'utf8'));
}

// æ–°ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
existing.entries.push({
  date,
  heatmap,
  total: tasks.length
});

// ä¿å­˜
fs.writeFileSync(heatmapPath, JSON.stringify(existing, null, 2));

return [{ json: { date, heatmap, total: tasks.length } }];
```

---

### 4. Entry Gateæ¡ä»¶ï¼ˆCategory Analyticsï¼‰

**ãƒã‚§ãƒƒã‚¯æ–¹æ³•**:
```bash
# category_heatmap.jsonãŒå­˜åœ¨ã™ã‚‹ã‹
cat cortex/state/category_heatmap.json | jq '.entries | length'

# ã‚«ãƒ†ã‚´ãƒªç¨®é¡ã‚’ç¢ºèª
cat cortex/state/category_heatmap.json | jq '.entries[-1].heatmap | keys'

# æ¬ æç‡è¨ˆç®—ï¼ˆgeneralä»¥å¤–ãŒ80%ä»¥ä¸Šã‚ã‚Œã°OKï¼‰
```

**æœŸå¾…çµæœ**:
- 5ã‚«ãƒ†ã‚´ãƒªä»¥ä¸Šå­˜åœ¨ï¼ˆdev, doc, ops, research, meetingï¼‰
- æ¬ æç‡ < 20%ï¼ˆå®Ÿè³ªã€generalå«ã‚ã¦100%ã‚«ãƒãƒ¼ï¼‰
- category_samples > 50

---

## ğŸ¯ 12/15 Entry Gate åˆ¤å®šãƒã‚§ãƒƒã‚¯ï¼ˆè¶…çŸ­ç¸®ç‰ˆï¼‰

### å½“æ—¥å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# 1. Observabilityç¢ºèª
python3 scripts/analyze-health.py --window-days 7
# æœŸå¾…: Automation score ãŒ no_data ã§ãªã„

# 2. Categoryç¢ºèª
cat cortex/state/category_heatmap.json | jq '.entries | length'
# æœŸå¾…: 7ä»¥ä¸Šï¼ˆ7æ—¥åˆ†ï¼‰

cat cortex/state/category_heatmap.json | jq '.entries[-1].heatmap | keys | length'
# æœŸå¾…: 5ä»¥ä¸Šï¼ˆdev, doc, ops, research, meetingï¼‰

# 3. ç·åˆHealth Score
python3 scripts/analyze-health.py --window-days 7 | jq '.overall_score'
# æœŸå¾…: 65ä»¥ä¸Š
```

### åˆ¤å®šåŸºæº–

| é …ç›® | æ¡ä»¶ | ç¢ºèªæ–¹æ³• |
|------|------|----------|
| Observability | `no_data` ã§ãªã„ | `analyze-health.py` å®Ÿè¡Œ |
| Categoryç¨®é¡ | 5ç¨®ä»¥ä¸Š | `category_heatmap.json` ã®keysç¢ºèª |
| Categoryæ¬ æç‡ | < 20% | generalå«ã‚ã¦ã»ã¼100%ã‚«ãƒãƒ¼ |
| Overall Score | 65ä»¥ä¸Š | health-score.json |

**ã™ã¹ã¦æº€ãŸã›ã°**: âœ… Entry Gate pass â†’ v1.3ãƒ‡ãƒ¼ã‚¿è“„ç©ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹

---

## ğŸ“… å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆåœŸæ—¥ï¼‰

### åœŸæ›œæ—¥ï¼ˆ2-3æ™‚é–“ï¼‰

1. **Log Collector Workflowä½œæˆ**ï¼ˆ1æ™‚é–“ï¼‰
   - Webhook Triggerè¨­å®š
   - Format + Append to Fileå®Ÿè£…
   - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæ‰‹å‹•ã§Webhookã‚’å©ãï¼‰

2. **Recipe 10ã«ãƒ­ã‚°é€ä¿¡è¿½åŠ **ï¼ˆ30åˆ†ï¼‰
   - Prepare Log Entry ãƒãƒ¼ãƒ‰ä½œæˆ
   - HTTP Request ãƒãƒ¼ãƒ‰è¿½åŠ 
   - æ‰‹å‹•å®Ÿè¡Œã§ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª

3. **ä»–Recipeã¸ã®å±•é–‹**ï¼ˆ1æ™‚é–“ï¼‰
   - Recipe 02, 03, 11, 13, 14ã«ãƒ­ã‚°é€ä¿¡è¿½åŠ 
   - å„Recipeæ‰‹å‹•å®Ÿè¡Œã§ãƒ­ã‚°ç¢ºèª

### æ—¥æ›œæ—¥ï¼ˆ2æ™‚é–“ï¼‰

4. **Categoryæ¨å®šãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…**ï¼ˆ1æ™‚é–“ï¼‰
   - Recipe 14ã« Estimate Category ãƒãƒ¼ãƒ‰è¿½åŠ 
   - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæ‰‹å‹•ã§ã‚¿ã‚¹ã‚¯ã‚’æµã™ï¼‰
   - ã‚«ãƒ†ã‚´ãƒªçµæœç¢ºèª

5. **category_heatmap.jsonæ›´æ–°**ï¼ˆ1æ™‚é–“ï¼‰
   - Update Category Heatmap ãƒãƒ¼ãƒ‰è¿½åŠ 
   - 7æ—¥åˆ†ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
   - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèª

### æœˆæ›œæ—¥ï¼ˆç¢ºèªã®ã¿ã€15åˆ†ï¼‰

6. **Entry Gateåˆ¤å®š**
   - ä¸Šè¨˜ã®åˆ¤å®šã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
   - Overall Scoreç¢ºèª
   - passåˆ¤å®šãªã‚‰v1.3ãƒ‡ãƒ¼ã‚¿è“„ç©é–‹å§‹

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œãªã„

**åŸå› **: ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æ¨©é™ä¸è¶³

**è§£æ±º**:
```bash
# cortex/logs/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p cortex/logs
chmod 755 cortex/logs

# n8nã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰æ›¸ãè¾¼ã‚ã‚‹ã‹ç¢ºèª
docker exec -it n8n touch /workspace/dauberside.github.io-1/cortex/logs/test.txt
```

### Q2: analyze-health.pyãŒno_dataã®ã¾ã¾

**åŸå› **: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãŒé–“é•ã£ã¦ã„ã‚‹

**è§£æ±º**:
```bash
# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
ls -lh cortex/logs/

# analyze-health.pyã®ãƒ­ã‚°ãƒ‘ã‚¹è¨­å®šã‚’ç¢ºèª
# ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®LOG_DIRã‚’ cortex/logs/ ã«è¨­å®šï¼‰
```

### Q3: ã‚«ãƒ†ã‚´ãƒªãŒå…¨ã¦generalã«ãªã‚‹

**åŸå› **: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒã—ã¦ã„ãªã„

**è§£æ±º**:
```javascript
// ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒãƒƒãƒã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
console.log('Title:', title);
console.log('Matched keywords:', matchedKeywords);
console.log('Scores:', scores);
```

---

**ä½œæˆæ—¥**: 2025-12-13
**å®Ÿè£…æœŸé™**: 2025-12-15
**Entry Gateåˆ¤å®š**: 2025-12-15 12:00 JST
