# v1.2 フォローアップチケット

> Recipe 13 動作確認で発見した改善点（2025-11-25）

---

## 🐛 Issue 1: Recipe 13 実行時刻のズレ（22:00 vs 22:30）

**優先度**: P2
**ラベル**: `v1.2`, `bug`, `recipe`, `cortex-os`

### 現象

Recipe 13（Nightly Wrap-up）の実行時刻が期待値とズレている。

- **設定**: 22:00（n8n scheduleTrigger）
- **実際**: 22:30（tomorrow.json のタイムスタンプから確認）
- **ズレ**: 30分遅延

### 調査項目

1. **n8n Cron ノード設定**
   - `services/n8n/workflows/recipe-13-nightly-wrapup.json` の `triggerTimes` 確認
   - n8n UI でスケジュール設定を確認

2. **タイムゾーン設定**
   - n8n コンテナの `TZ` 環境変数
   - `GENERIC_TIMEZONE=Asia/Tokyo` が正しく設定されているか
   - サーバー側のタイムゾーン

3. **システム時刻**
   - Docker ホストの時刻が正確か
   - n8n コンテナ内の時刻を確認

### 期待するゴール

以下のいずれかを達成：

1. **22:00 JST に修正**
   - n8n 設定を調整して、きっちり 22:00 に実行

2. **22:30 を正式仕様とする**
   - ドキュメントとワークフロー名を更新
   - v1.2 Roadmap の説明も修正

### 関連ファイル

- `services/n8n/workflows/recipe-13-nightly-wrapup.json`
- `cortex/state/tomorrow.json`（実行時刻の確認）
- `docs/operations/n8n-production-deployment.md`

---

## 🔧 Issue 2: Reflection 抽出ロジックの修正

**優先度**: P1（v1.2 の「自律性」に直結）
**ラベル**: `v1.2`, `enhancement`, `recipe`, `cortex-os`

### 現象

`tomorrow.json` の `reflection_summary` が古いデータのまま固定されている。

```json
{
  "reflection_summary": "Source: /brief command、GeneratedAt: 2025-11-20T00:00:00Z"
}
```

- 2025-11-24 の Daily Digest から Reflection が抽出されていない
- `GeneratedAt` が 11/20 のまま

### 原因調査

Recipe 13 の `Build tomorrow.json` ノード（`services/n8n/workflows/recipe-13-nightly-wrapup.json`）で：

1. `extractReflection()` 関数が正しく動作していない可能性
2. Daily Digest の Reflection セクションのフォーマットが期待と異なる
3. Reflection が空の場合のフォールバック処理

### 期待する動作

毎晩の wrap-up 時に：
1. **最新の Daily Digest** から `## Reflection` セクションを抽出
2. Reflection が無い場合: `"（Reflection なし）"` または前日のサマリーを使用
3. `generated_at` を現在時刻で更新

### 実装案

#### Option 1: Reflection 抽出ロジックの修正

```javascript
function extractReflection(text) {
  // ## Reflection セクションを探す
  const reflectionMatch = text.match(/## Reflection\s*\n([\s\S]*?)(?=\n##|$)/);
  if (!reflectionMatch) return '（Reflection なし）';

  // - で始まる行を抽出
  const lines = reflectionMatch[1]
    .split('\n')
    .filter(l => l.trim().startsWith('- '))
    .map(l => l.trim().replace(/^- /, ''));

  return lines.join('、') || '（Reflection なし）';
}
```

#### Option 2: Daily Digest のテンプレート統一

- Daily Digest の Reflection セクションを必須化
- フォーマットを統一（必ず `- ` で箇条書き）

### 関連

- Recipe 13
- Daily Digest テンプレート
- cortex/daily/*.md

---

## 📝 Issue 3: Slack 通知の動作確認とドキュメント化

**優先度**: P1（v1.2 の UX に直結）
**ラベル**: `v1.2`, `documentation`, `recipe`, `cortex-os`

### 目的

Recipe 13（Nightly Wrap-up）の Slack 通知が正しく動作していることを確認し、通知フローをドキュメント化する。

### 確認項目

#### 1. Slack 通知の送信確認

- [ ] Recipe 13 実行時に Slack DM が送信されているか
- [ ] 通知内容が期待通りか（完了数、未完了数、明日の候補）
- [ ] `SLACK_DAILY_DIGEST_WEBHOOK` 環境変数が正しく設定されているか

#### 2. 通知フローの把握

現在の Recipe と Slack チャンネル/DM の対応を整理：

| Recipe | 通知先 | 内容 |
|--------|--------|------|
| Recipe 13: Nightly Wrap-up | ? | 完了/未完了/明日の候補 |
| Recipe 09: Daily Digest → Slack | ? | Daily Digest 全体 |
| Recipe 01: Obsidian → Slack | ? | Obsidian ノート更新 |

#### 3. 通知テンプレートの固定

Recipe 13 の Slack 通知メッセージ例：

```
🌙 *Cortex OS Nightly Wrap-up — 2025-11-24*

• 完了: 3
• 未完了: 0
• 進捗率: 100%

*明日の候補:*
• v1.2 Roadmap 確認
• Recipe 動作確認
• ドキュメント整理

_tomorrow.json を更新しました_
```

### 期待するゴール

1. **朝 Slack を開いたら「今日の3タスク」が必ず届いている** 状態の担保
2. どの Recipe が、どのチャンネル/DM に投げているかを `docs/` に記録
3. 通知が届かない場合のトラブルシューティング手順を作成

### 実装タスク

- [ ] 昨夜の Recipe 13 実行ログと Slack を突き合わせて確認
- [ ] `docs/operations/slack-notification-flow.md` を作成
  - Recipe ごとの通知先マッピング
  - Webhook URL の管理方法
  - トラブルシューティング
- [ ] 通知テンプレートを `services/n8n/workflows/` に JSON として保存

### 関連

- Recipe 13, Recipe 09, Recipe 01
- Slack Webhook 設定
- `cortex/secrets-reference.md`

---

## 📅 次のアクション

### 次回セッション候補

1. **n8n 本番デプロイ実装**
   - 決定した方針（自前サーバー + Docker）を形にする
   - v1.2 必須要件（常時稼働、HTTPS、認証、バックアップ）を実装

2. **P1 Issue の解消**
   - Issue 2: Reflection 抽出ロジック修正
   - Issue 3: Slack 通知の確認

3. **v1.2 Week 2 へ進む**
   - 情報モデル統一（task-entry.json スキーマ設計）

---

**作成日**: 2025-11-25
**状態**: v1.2 Week 1 完了、Week 2 準備完了
